<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>System Monitorowania Zasob√≥w Gminy | SharkIT</title>
    <!-- Load styles first -->
    <link rel="stylesheet" href="styles.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <!-- <script src="https://cdn.tailwindcss.com"></script> -->
    <!-- Removed CDN -->
    <link href="./dist/tailwind-output.css" rel="stylesheet" />
    <!-- Added local Tailwind CSS -->

    <!-- Environment Setup - Must be loaded first -->
    <script src="env-setup.js"></script>

    <!-- Load data files directly for immediate access -->
    <script>
      // Load mock data directly
      window.loadJsonFiles = async () => {
        try {
          // Load all mock data files
          const files = [
            { name: "demographic", key: "demographic" },
            { name: "gminas", key: "gminas" },
            { name: "resources", key: "resources" },
          ];

          for (const file of files) {
            const response = await fetch(`mocks/${file.name}.json`);
            if (response.ok) {
              const data = await response.json();
              localStorage.setItem(file.key, JSON.stringify(data));
              console.log(
                `Loaded ${file.name} data into localStorage directly`
              );
            } else {
              console.error(`Failed to load ${file.name}.json`);
            }
          }

          console.log("All mock data loaded successfully");
          document.dispatchEvent(new CustomEvent("mockDataLoaded"));
        } catch (error) {
          console.error("Error loading mock data files:", error);
        }
      };

      // Start loading immediately
      window.loadJsonFiles();
    </script>

    <!-- Load libraries -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Load mock data and mock services -->
    <script src="mocks/mockData.js"></script>
    <script src="mocks/routerHelper.js"></script>

    <!-- Load mock API and AI implementations -->
    <script src="mocks/mockAPI.js"></script>
    <script src="mocks/mockAI.js"></script>
    <script src="mocks/realAI.js"></script>
    <script src="mocks/openaiProxy.js"></script>

    <!-- Main application script loaded last -->
    <script type="text/babel" src="script.js"></script>
  </head>
  <body>
    <div id="root">
      <div
        style="
          display: flex;
          justify-content: center;
          align-items: center;
          height: 100vh;
          text-align: center;
        "
      >
        <div>
          <h2>Loading application data...</h2>
          <p>Please wait while the mock data is being loaded.</p>
        </div>
      </div>
    </div>

    <!-- React handles the panel toggling -->

    <script type="text/babel">
      // Wait for mock data to be fully loaded before initializing React app
      document.addEventListener("mockDataLoaded", () => {
        console.log("Mock data loaded, initializing React app");
      });

      // The application uses mock data from the mocks/mockData.js file
      // All previously hardcoded mock data has been moved to JSON files in the mocks directory
      // Icons - using inline SVGs for self-contained file
      const UserIcon = () => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="48"
          height="48"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
      );

      const UsersIcon = () => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="48"
          height="48"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
          <circle cx="9" cy="7" r="4"></circle>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
      );

      const ShieldIcon = () => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="48"
          height="48"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
        </svg>
      );

      const AlertCircleIcon = () => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="48"
          height="48"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
      );

      const HomeIcon = () => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
      );

      // AI Assistant Icon
      const AIAssistantIcon = () => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <path d="M7 7h.01"></path>
          <path d="M17 7h.01"></path>
          <path d="M12 17v-6"></path>
          <path d="M8 11h8"></path>
          <path d="M8 14h8"></path>
        </svg>
      );

      // --- NEW ICONS FOR PAIN POINTS ---
      const LayersIcon = () => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
          <polyline points="2 17 12 22 22 17"></polyline>
          <polyline points="2 12 12 17 22 12"></polyline>
        </svg>
      );

      const ShuffleIcon = () => (
        // For coordination problems
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <polyline points="16 3 21 3 21 8"></polyline>
          <line x1="4" y1="20" x2="21" y2="3"></line>
          <polyline points="21 16 21 21 16 21"></polyline>
          <line x1="15" y1="15" x2="21" y2="21"></line>
          <line x1="4" y1="4" x2="9" y2="9"></line>
        </svg>
      );

      const ArchiveIcon = () => (
        // For administrative burden
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="8" y1="12" x2="16" y2="12"></line>
        </svg>
      );

      const EyeOffIcon = () => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
          <line x1="1" y1="1" x2="23" y2="23"></line>
        </svg>
      );

      const UsersMinusIcon = () => (
        // For poor inter-municipal coordination
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
          <circle cx="8.5" cy="7" r="4"></circle>
          <line x1="23" y1="11" x2="17" y2="11"></line>
        </svg>
      );

      const ClockIcon = () => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
      );

      const MoveIcon = () => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <polyline points="5 9 2 12 5 15"></polyline>
          <polyline points="9 5 12 2 15 5"></polyline>
          <polyline points="15 19 12 22 9 19"></polyline>
          <polyline points="19 9 22 12 19 15"></polyline>
          <line x1="2" y1="12" x2="22" y2="12"></line>
          <line x1="12" y1="2" x2="12" y2="22"></line>
        </svg>
      );

      const FileXIcon = () => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
          <line x1="9.5" y1="12.5" x2="14.5" y2="17.5"></line>
          <line x1="14.5" y1="12.5" x2="9.5" y2="17.5"></line>
        </svg>
      );

      const SlidersHorizontalIcon = () => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <line x1="21" y1="10" x2="3" y2="10"></line>
          <line x1="21" y1="6" x2="3" y2="6"></line>
          <line x1="21" y1="14" x2="3" y2="14"></line>
          <line x1="21" y1="18" x2="3" y2="18"></line>
        </svg>
      );

      const BriefcaseIcon = () => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
          <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
        </svg>
      );

      const BotIcon = () => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <path d="M12 8V4H8"></path>
          <rect width="16" height="12" x="4" y="8" rx="2"></rect>
          <path d="M2 14h2"></path>
          <path d="M20 14h2"></path>
          <path d="M15 13v2"></path>
          <path d="M9 13v2"></path>
        </svg>
      );

      const AlertTriangleIcon = () => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="orange"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path>
          <path d="M12 9v4"></path>
          <path d="M12 17h.01"></path>
        </svg>
      );

      const WindIcon = () => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <path d="M17.7 7.7a2.5 2.5 0 1 1-5 0"></path>
          <path d="M19.6 21H12a3 3 0 0 1-3-3v0"></path>
          <path d="M22 17H4.4"></path>
          <path d="M20 12H6.8"></path>
          <path d="M17.7 7.7a2.5 2.5 0 1 1-5 0"></path>
          <path d="M12.2 4.1a2.5 2.5 0 0 1 5 .1"></path>
        </svg>
      );

      // --- END NEW ICONS ---

      const PlusCircleIcon = () => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <circle cx="12" cy="12" r="10"></circle>
          <path d="M8 12h8"></path>
          <path d="M12 8v8"></path>
        </svg>
      );

      // Reusable PainPointAccordion Component -- THIS COMPONENT WILL BE REMOVED
      /*
      const PainPointAccordion = ({ icon, title, summary, details, accentColor,textColor, lightBgColor }) => {
        const [isOpen, setIsOpen] = React.useState(false);
        const IconComponent = icon;

        return (
          <div className={`mb-4 rounded-lg shadow-md border border-gray-200 ${lightBgColor || 'bg-gray-50'}`}>
            <button
              onClick={() => setIsOpen(!isOpen)}
              className="w-full flex items-center justify-between p-4 text-left"
            >
              <div className="flex items-center">
                <span className={`${textColor || 'text-gray-700'} mr-3`}><IconComponent /></span>
                <h3 className={`font-semibold ${textColor || 'text-gray-800'}`}>{title}</h3>
              </div>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                strokeWidth="2"
                strokeLinecap="round"
                strokeLinejoin="round"
                className={`transform transition-transform duration-200 ${isOpen ? 'rotate-180' : ''} ${textColor || 'text-gray-600'}`}
              >
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
            {isOpen && (
              <div className="p-4 border-t border-gray-200">
                <p className="text-sm text-gray-600 mb-2">{summary}</p>
                <p className="text-xs text-gray-500 whitespace-pre-line">{details}</p>
              </div>
            )}
          </div>
        );
      };
      */

      // Placeholder Local Crisis Mode Component
      const LocalCrisisMode = () => {
        // REMOVING painPoints array and PainPointAccordion usage
        const mapRefLocalCrisis = React.useRef(null);

        React.useEffect(() => {
          if (
            !mapRefLocalCrisis.current &&
            document.getElementById("mapLocalCrisis")
          ) {
            const map = L.map("mapLocalCrisis").setView([51.367, 19.367], 12); // Example coords from LocalAdminDashboard
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
              attribution:
                '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            }).addTo(map);
            mapRefLocalCrisis.current = map;

            // Example: Add a crisis marker
            // Using a simple orange circle for the crisis marker
            const crisisIcon = L.divIcon({
              className: "custom-div-icon", // ensure this class doesn't conflict or define its specific styles if needed
              html: `<div style="background-color: orange; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px orange; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">!</div>`,
              iconSize: [20, 20],
              iconAnchor: [10, 10], // anchor point of the icon
            });

            L.marker([51.37, 19.37], { icon: crisisIcon }) // Slightly different coords for visibility
              .bindPopup(
                "<b>Zg≈Çoszenie Kryzysowe</b><br/>Po≈ºar magazynu przy ul. Przemys≈Çowej."
              )
              .addTo(map);

            // Add new fire event for Gmina Be≈Çchat√≥w
            L.marker([51.36, 19.37], { icon: crisisIcon })
              .bindPopup(
                "<b>Nowe Zg≈Çoszenie Kryzysowe</b><br/>Gmina Be≈Çchat√≥w: Po≈ºar lasu w pobli≈ºu ul. Le≈õnej."
              )
              .addTo(map);
          }
          return () => {
            if (mapRefLocalCrisis.current) {
              mapRefLocalCrisis.current.remove();
              mapRefLocalCrisis.current = null;
            }
          };
        }, []);

        return (
          <div className="min-h-screen flex flex-col bg-gray-100">
            {/* Header remains the same, part of the column flow */}
            <header className="bg-white shadow-md">
              <div style={{ backgroundColor: "#182139" }} className="px-6 py-4">
                <div className="flex items-center justify-between">
                  <div className="flex items-center">
                    <button
                      onClick={() => setCurrentView("home")}
                      className="flex items-center px-3 py-2 text-white hover:bg-opacity-75 hover:bg-gray-700 rounded-md"
                    >
                      <HomeIcon />
                      <span className="ml-2 text-sm">Powr√≥t do wyboru</span>
                    </button>
                    <h1 className="ml-6 text-xl font-semibold text-white">
                      Tryb Kryzysowy - S≈Çu≈ºby Lokalne
                    </h1>
                  </div>
                  {/* Potentially add other header elements here if needed */}
                </div>
              </div>
            </header>

            {/* Content Area with Sidebar and Map - This will be a flex row */}
            <div className="flex flex-1 overflow-hidden">
              {/* Sidebar */}
              <div className="w-96 bg-white p-6 shadow-lg overflow-y-auto border-r border-gray-200">
                <h2 className="text-xl font-semibold text-orange-700 mb-6">
                  Panel ZarzƒÖdzania Kryzysowego
                </h2>

                {/* Section: Report Event / Request Help */}
                <div className="mb-6">
                  <h3 className="text-lg font-medium text-gray-800 mb-3">
                    Zg≈Ço≈õ Zdarzenie / Popro≈õ o Pomoc
                  </h3>
                  <button className="w-full bg-orange-500 text-white px-4 py-2 rounded-md hover:bg-orange-600 transition-colors flex items-center justify-center">
                    <PlusCircleIcon />
                    <span className="ml-2">Nowe Zg≈Çoszenie</span>
                  </button>
                  {/* TODO: Add form elements or modal trigger here */}
                </div>

                {/* Section: Active Requests */}
                <div className="mb-6">
                  <h3 className="text-lg font-medium text-gray-800 mb-3">
                    Aktywne Zg≈Çoszenia
                  </h3>
                  <div className="p-4 bg-orange-50 border border-orange-200 rounded-md">
                    <p className="text-sm text-orange-600">
                      Brak aktywnych zg≈Çosze≈Ñ.
                    </p>
                    {/* Example of a request item:
                    <div className="p-3 my-2 bg-white border border-gray-200 rounded-md shadow-sm">
                      <p className="font-semibold text-gray-700">Potrzeba: Pompa wodna</p>
                      <p className="text-xs text-gray-500">Status: OczekujƒÖce na potwierdzenie Wojewody</p>
                    </div>
                    */}
                  </div>
                </div>

                {/* Section: Local Crisis Resources */}
                <div>
                  <h3 className="text-lg font-medium text-gray-800 mb-3">
                    Lokalne Zasoby Kryzysowe
                  </h3>
                  <div className="p-4 bg-gray-50 border border-gray-200 rounded-md">
                    <p className="text-sm text-gray-600">
                      PrzeglƒÖd lokalnych zasob√≥w dostƒôpny wkr√≥tce.
                    </p>
                    {/* Could link to a detailed view or show key stats */}
                  </div>
                </div>
              </div>

              {/* Map Area */}
              <main className="flex-1 p-6 bg-gray-200 overflow-y-auto">
                <div
                  id="mapLocalCrisis"
                  style={{
                    height: "100%",
                    minHeight: "calc(100vh - 150px)",
                    borderRadius: "8px",
                  }} // Adjusted height
                  className="shadow-lg bg-white" // Added bg-white for placeholder visibility before map loads
                >
                  {/* Map will be rendered here by Leaflet */}
                </div>
              </main>
            </div>
          </div>
        );
      };

      // Placeholder Global Crisis Mode Component
      const GlobalCrisisMode = () => {
        const mapRefGlobalCrisis = React.useRef(null);
        const [activeAlerts, setActiveAlerts] = React.useState([
          {
            id: 1,
            gmina: "Gmina Be≈Çchat√≥w",
            type: "Pow√≥d≈∫",
            severity: "Wysoka",
            details: "Zalane centrum, potrzeba ewakuacji.",
            lat: 51.367,
            lng: 19.367,
            status: "Nowe",
          },
          {
            id: 2,
            gmina: "Gmina Kleszcz√≥w",
            type: "Po≈ºar Lasu",
            severity: "≈örednia",
            details: "Pali siƒô obszar le≈õny na p√≥≈Çnocy gminy.",
            lat: 51.25,
            lng: 19.3,
            status: "Weryfikacja",
          },
          {
            id: 3,
            gmina: "Gmina Dru≈ºbice",
            type: "Brak Zasilania",
            severity: "Krytyczna",
            details: "Ca≈Ça gmina bez prƒÖdu po burzy.",
            lat: 51.45,
            lng: 19.4,
            status: "W toku",
          },
          {
            id: 4,
            gmina: "Miasto ≈Å√≥d≈∫",
            type: "Ska≈ºenie Chemiczne",
            severity: "Krytyczna",
            details: "Wyciek nieznanej substancji w strefie przemys≈Çowej.",
            lat: 51.7592,
            lng: 19.4558,
            status: "Nowe",
          },
        ]);

        React.useEffect(() => {
          let mapInstance = null;
          if (
            !mapRefGlobalCrisis.current &&
            document.getElementById("mapGlobalCrisis")
          ) {
            mapInstance = L.map("mapGlobalCrisis").setView(
              [51.9194, 19.1451],
              7
            ); // Center of Poland, wider view

            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
              attribution:
                '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            }).addTo(mapInstance);

            mapRefGlobalCrisis.current = mapInstance;
          } else {
            mapInstance = mapRefGlobalCrisis.current;
          }

          if (mapInstance) {
            // Clear existing crisis markers before adding new ones
            mapInstance.eachLayer((layer) => {
              // A more robust check for your specific crisis markers might be needed
              if (
                layer.options &&
                layer.options.pane === "markerPane" &&
                layer.options.icon &&
                layer.options.icon.options.className &&
                layer.options.icon.options.className.includes(
                  "custom-crisis-marker"
                )
              ) {
                mapInstance.removeLayer(layer);
              }
            });

            activeAlerts.forEach((alert) => {
              const crisisIconHtml = `<div style="background-color: ${
                alert.severity === "Krytyczna"
                  ? "#dc2626" /* red-600 */
                  : alert.severity === "Wysoka"
                  ? "#f97316" /* orange-500 */
                  : "#f59e0b" /* amber-500 */
              }; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; border: 2px solid white; box-shadow: 0 0 5px ${
                alert.severity === "Krytyczna"
                  ? "#dc2626"
                  : alert.severity === "Wysoka"
                  ? "#f97316"
                  : "#f59e0b"
              };">üö®</div>`;

              const crisisIcon = L.divIcon({
                className: "custom-crisis-marker",
                html: crisisIconHtml,
                iconSize: [24, 24],
                iconAnchor: [12, 12],
              });
              L.marker([alert.lat, alert.lng], { icon: crisisIcon })
                .bindPopup(
                  `<b>${alert.gmina} - ${alert.type}</b><br/>Stopie≈Ñ: ${alert.severity}<br/>Status: ${alert.status}<hr/>${alert.details}`
                )
                .addTo(mapInstance);
            });
          }

          return () => {
            if (mapRefGlobalCrisis.current) {
              const mapContainer = document.getElementById("mapGlobalCrisis");
              if (
                mapContainer &&
                mapRefGlobalCrisis.current._container === mapContainer
              ) {
                mapRefGlobalCrisis.current.remove();
              }
              mapRefGlobalCrisis.current = null;
            }
          };
        }, [activeAlerts]);

        return (
          <div className="min-h-screen flex flex-col bg-gray-100">
            {/* Header */}
            <header className="bg-white shadow-md">
              <div style={{ backgroundColor: "#182139" }} className="px-6 py-4">
                <div className="flex items-center justify-between">
                  <div className="flex items-center">
                    <button
                      onClick={() => setCurrentView("home")}
                      className="flex items-center px-3 py-2 text-white hover:bg-opacity-75 hover:bg-gray-700 rounded-md"
                    >
                      <HomeIcon />
                      <span className="ml-2 text-sm">Powr√≥t do wyboru</span>
                    </button>
                    <h1 className="ml-6 text-xl font-semibold text-white">
                      Tryb Kryzysowy - Globalny (Centrala)
                    </h1>
                  </div>
                </div>
              </div>
            </header>

            {/* Content Area with Sidebar and Map */}
            <div className="flex flex-1 overflow-hidden">
              {/* Sidebar */}
              <div className="w-96 bg-white p-6 shadow-lg overflow-y-auto border-r border-gray-200">
                <div className="flex items-center text-xl font-semibold text-red-700 mb-6">
                  <ShieldIcon /> {/* Using the 48x48 ShieldIcon */}
                  <span className="ml-3">Panel Centrali Kryzysowej</span>
                </div>

                {/* Section: Global Crisis Notifications */}
                <div className="mb-8">
                  <h3 className="text-lg font-medium text-gray-800 mb-3">
                    Zg≈Çoszenia Kryzysowe (Wojew√≥dztwo)
                  </h3>
                  {activeAlerts.length > 0 ? (
                    <ul className="space-y-3">
                      {activeAlerts.map((alert) => (
                        <li
                          key={alert.id}
                          className={`p-3 rounded-md border ${
                            alert.severity === "Krytyczna"
                              ? "border-red-500 bg-red-50"
                              : alert.severity === "Wysoka"
                              ? "border-orange-500 bg-orange-50"
                              : "border-yellow-400 bg-yellow-50" // Default for '≈örednia'
                          }`}
                        >
                          <div className="flex justify-between items-start">
                            <div>
                              <p
                                className={`font-semibold ${
                                  alert.severity === "Krytyczna"
                                    ? "text-red-700"
                                    : alert.severity === "Wysoka"
                                    ? "text-orange-700"
                                    : "text-yellow-600"
                                }`}
                              >
                                {alert.gmina}: {alert.type}
                              </p>
                              <p className="text-xs text-gray-600">
                                {alert.details}
                              </p>
                            </div>
                            <span
                              className={`text-xs font-bold px-2 py-0.5 rounded-full ${
                                alert.status === "Nowe"
                                  ? "bg-blue-200 text-blue-800"
                                  : alert.status === "Weryfikacja"
                                  ? "bg-yellow-200 text-yellow-800"
                                  : "bg-green-200 text-green-800" // Default for 'W toku' or other statuses
                              }`}
                            >
                              {alert.status}
                            </span>
                          </div>
                          <button
                            onClick={() => {
                              if (mapRefGlobalCrisis.current) {
                                mapRefGlobalCrisis.current.flyTo(
                                  [alert.lat, alert.lng],
                                  10
                                ); // Zoom to alert
                              }
                            }}
                            className="mt-2 text-xs text-blue-600 hover:underline"
                          >
                            Zobacz na mapie / ZarzƒÖdzaj
                          </button>
                        </li>
                      ))}
                    </ul>
                  ) : (
                    <div className="p-4 bg-green-50 border border-green-200 rounded-md">
                      <p className="text-sm text-green-600 text-center">
                        Brak aktywnych zg≈Çosze≈Ñ kryzysowych na poziomie
                        wojew√≥dztwa.
                      </p>
                    </div>
                  )}
                </div>

                {/* Section: Global Situation Overview */}
                <div className="mb-8">
                  <h3 className="text-lg font-medium text-gray-800 mb-3">
                    PrzeglƒÖd Sytuacji Globalnej
                  </h3>
                  <div className="grid grid-cols-2 gap-3">
                    <div className="bg-blue-50 p-3 rounded-lg border border-blue-200">
                      <p className="text-xs text-blue-700">Gminy z alertami</p>
                      <p className="text-lg font-bold text-blue-800">
                        {new Set(activeAlerts.map((a) => a.gmina)).size}
                      </p>
                    </div>
                    <div className="bg-red-50 p-3 rounded-lg border border-red-200">
                      <p className="text-xs text-red-700">Alerty krytyczne</p>
                      <p className="text-lg font-bold text-red-800">
                        {
                          activeAlerts.filter((a) => a.severity === "Krytyczna")
                            .length
                        }
                      </p>
                    </div>
                    <div className="bg-orange-50 p-3 rounded-lg border border-orange-200">
                      <p className="text-xs text-orange-700">Alerty wysokie</p>
                      <p className="text-lg font-bold text-orange-800">
                        {
                          activeAlerts.filter((a) => a.severity === "Wysoka")
                            .length
                        }
                      </p>
                    </div>
                    <div className="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                      <p className="text-xs text-yellow-700">Alerty ≈õrednie</p>
                      <p className="text-lg font-bold text-yellow-800">
                        {
                          activeAlerts.filter((a) => a.severity === "≈örednia")
                            .length
                        }
                      </p>
                    </div>
                  </div>
                </div>
              </div>

              {/* Map Area */}
              <main className="flex-1 p-6 bg-gray-200 overflow-y-auto">
                <div
                  id="mapGlobalCrisis"
                  style={{
                    height: "100%",
                    minHeight: "calc(100vh - 150px)",
                    borderRadius: "8px",
                  }}
                  className="shadow-lg bg-white"
                >
                  {/* Map will be rendered here by Leaflet */}
                </div>
              </main>
            </div>
          </div>
        );
      };

      // Placeholder Global Admin Component
      const GlobalAdmin = () => {
        // REMOVING painPoints array and PainPointAccordion usage
        // ADDING new state and logic for multi-gmina map view

        // Use gmina data from the external mock file
        const gminaData = mockData.gminas;

        const [selectedGminaId, setSelectedGminaId] = React.useState("gminaA");
        const mapRefGlobal = React.useRef(null);
        const layerControlRefGlobal = React.useRef(null);

        const currentGmina = gminaData[selectedGminaId];

        // Simplified getCustomIcon - can be expanded later if needed
        const getCustomIconGlobal = (type) => {
          let color = "gray";
          switch (type) {
            case "storage":
              color = "#2ecc71";
              break; // Green
            case "emergency_service":
              color = "#e74c3c";
              break; // Red
            case "medical_point":
              color = "#e91e63";
              break; // Pink
            case "institution":
              color = "#3498db";
              break; // Blue
            default:
              color = "#7f8c8d";
          }
          return L.divIcon({
            className: "custom-div-icon",
            html: `<div style="background-color: ${color}; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 3px ${color};"></div>`,
            iconSize: [16, 16],
            iconAnchor: [8, 8],
          });
        };

        React.useEffect(() => {
          if (!currentGmina) return;

          if (mapRefGlobal.current) {
            // If map exists, just update view and layers
            mapRefGlobal.current.setView(
              currentGmina.center,
              currentGmina.zoom
            );
            // Clear previous layers (simplified - ideally manage layers better)
            mapRefGlobal.current.eachLayer((layer) => {
              if (!!layer.toGeoJSON) {
                // Basic check if it's a data layer
                mapRefGlobal.current.removeLayer(layer);
              }
            });
            if (layerControlRefGlobal.current) {
              layerControlRefGlobal.current.remove();
            }
          } else {
            // Initialize map
            mapRefGlobal.current = L.map("mapGlobalAdmin").setView(
              currentGmina.center,
              currentGmina.zoom
            );
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
              attribution:
                '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            }).addTo(mapRefGlobal.current);
          }

          const map = mapRefGlobal.current;

          // Add resources for the selected gmina
          const resourceLayer = L.layerGroup();
          currentGmina.resources.forEach((resource) => {
            const icon = getCustomIconGlobal(resource.type);
            L.marker([resource.lat, resource.lng], { icon })
              .bindPopup(`<b>${resource.name}</b><br/>Typ: ${resource.type}`)
              .addTo(resourceLayer);
          });
          resourceLayer.addTo(map);

          // Add population zones for the selected gmina
          const populationLayer = L.layerGroup();
          currentGmina.populationZones.forEach((zone) => {
            let zoneColor =
              zone.density === "high"
                ? "#d32f2f"
                : zone.density === "medium"
                ? "#f57c00"
                : "#fbc02d";
            L.circle([zone.lat, zone.lng], {
              color: zoneColor,
              fillColor: zoneColor,
              fillOpacity: 0.3,
              radius: zone.radius,
            })
              .bindPopup(`<b>${zone.name}</b><br/>Gƒôsto≈õƒá: ${zone.density}`)
              .addTo(populationLayer);
          });
          populationLayer.addTo(map);

          // Simplified Layer Control
          const overlayMapsGlobal = {
            "Zasoby Gminy": resourceLayer,
            "Strefy Populacji": populationLayer,
          };

          layerControlRefGlobal.current = L.control
            .layers(null, overlayMapsGlobal)
            .addTo(map);

          return () => {
            // Cleanup on component unmount or before re-render if selectedGminaId changes and map needs full reinitialization
            // For simplicity, not fully cleaning up map instance here, but in a real app, you might want to.
            if (layerControlRefGlobal.current) {
              // layerControlRefGlobal.current.remove(); // Avoids error if map is removed first
            }
          };
        }, [selectedGminaId, currentGmina]);

        return (
          <div className="min-h-screen bg-gray-100 flex">
            {/* Sidebar for Gmina Selection */}
            <div
              style={{ backgroundColor: "#182139" }}
              className="w-72 p-4 space-y-2 text-white"
            >
              <button
                onClick={() => setCurrentView("home")}
                className="flex items-center px-3 py-2 text-white hover:bg-opacity-75 hover:bg-gray-700 rounded-md w-full mb-4"
              >
                <HomeIcon />
                <span className="ml-2 text-sm">Powr√≥t do wyboru</span>
              </button>
              <h2 className="text-lg font-semibold mb-3">Wybierz Gminƒô:</h2>
              {Object.values(gminaData).map((gmina) => (
                <div
                  key={gmina.id}
                  className={`p-3 mb-3 rounded-lg border-2 transition-all duration-200 ease-in-out cursor-pointer transform hover:scale-105 ${
                    selectedGminaId === gmina.id
                      ? "bg-blue-700 border-blue-500 shadow-xl"
                      : "bg-gray-800 border-gray-700 hover:bg-gray-700 hover:border-blue-600"
                  }`}
                  onClick={() => setSelectedGminaId(gmina.id)}
                >
                  <h4
                    className="font-semibold text-white text-base mb-1 truncate"
                    title={gmina.name}
                  >
                    {gmina.name}
                  </h4>
                  <p className="text-xs text-gray-200 mb-3">
                    Populacja: {gmina.population.toLocaleString()}
                  </p>
                  <div className="space-y-1.5">
                    <button
                      onClick={(e) => {
                        e.stopPropagation();
                        alert("Generowanie raportu dla: " + gmina.name);
                      }}
                      className="w-full text-xs bg-sky-600 hover:bg-sky-700 text-white py-1.5 px-2 rounded-md transition-colors duration-150 flex items-center justify-center"
                    >
                      <span>Raport</span>
                    </button>
                    <button
                      onClick={(e) => {
                        e.stopPropagation();
                        alert("Przesuwanie zasob√≥w dla: " + gmina.name);
                      }}
                      className="w-full text-xs bg-teal-600 hover:bg-teal-700 text-white py-1.5 px-2 rounded-md transition-colors duration-150 flex items-center justify-center"
                    >
                      <span>Przesu≈Ñ Zasoby</span>
                    </button>
                    <button
                      onClick={(e) => {
                        e.stopPropagation();
                        alert("Centralne zakupy dla: " + gmina.name);
                      }}
                      className="w-full text-xs bg-indigo-600 hover:bg-indigo-700 text-white py-1.5 px-2 rounded-md transition-colors duration-150 flex items-center justify-center"
                    >
                      <span>Centralne Zakupy</span>
                    </button>
                  </div>
                </div>
              ))}
            </div>

            {/* Main Content with Map */}
            <div className="flex-1 flex flex-col">
              <header className="bg-white shadow-md">
                <div className="px-6 py-4 border-b">
                  <h1 className="text-xl font-semibold text-green-700">
                    Panel ZarzƒÖdcy Globalnego - Wojew√≥dztwo ≈Å√≥dzkie - PrzeglƒÖd
                    Gmin
                  </h1>
                </div>
              </header>
              <main className="flex-1 p-6 bg-gray-200">
                <div
                  id="mapGlobalAdmin"
                  style={{ height: "100%", borderRadius: "8px" }}
                  className="shadow-lg"
                ></div>
              </main>
            </div>
          </div>
        );
      };

      const LocalAdminDashboard = () => {
        const [activeTab, setActiveTab] = React.useState("dashboard"); // Changed for diagnostics
        const [sidebarOpen, setSidebarOpen] = React.useState(true);
        const [animalManagementStrategy, setAnimalManagementStrategy] =
          React.useState("feed"); // 'feed', 'food_source', 'ignore'
        const mapRef = React.useRef(null); // Ref to store the map instance
        const mapContainerRef = React.useRef(null); // Ref for the map container div
        const layerControlRef = React.useRef(null); // Ref for layer control

        // State for Purchase Planning
        const [purchases, setPurchases] = React.useState([
          {
            id: 1,
            supplier: "Przetarg w toku",
            buyer: "≈Å√≥dzkie", // Foreign purchase that can be joined
            item: "Agregaty prƒÖdotw√≥rcze",
            quantity: "",
            isAiInput: false, // Will be true after clicking "Do≈ÇƒÖcz"
            canJoin: true, // Show "Do≈ÇƒÖcz" button initially in Ilo≈õƒá column
            isJoined: false, // When true, will show quantity input instead of "Do≈ÇƒÖcz" button
          },
        ]);
        const [showAiPanel, setShowAiPanel] = React.useState(false); // Keep true for now to see if it appears with correct tab
        const [currentAiContext, setCurrentAiContext] = React.useState(null); // { type: 'resources'/'emergency', resourceName: X }
        const [aiSuggestions, setAiSuggestions] = React.useState([]);
        const [aiAnalysisPlan, setAiAnalysisPlan] = React.useState([]);
        const [aiAssistantLog, setAiAssistantLog] = React.useState([]);
        const [crisisAlert, setCrisisAlert] = React.useState(false);
        const [aiPanelWidth, setAiPanelWidth] = React.useState(400); // Default width for AI panel
        const [isResizing, setIsResizing] = React.useState(false);
        const [currentTime, setCurrentTime] = React.useState(new Date());

        // Load AI assistant data on component mount
        React.useEffect(() => {
          // Load conversation history
          mockAI.getConversationLog().then((log) => {
            setAiAssistantLog(log);
          });

          // Check for crisis alerts periodically
          const crisisCheckInterval = setInterval(() => {
            mockAI.detectCrisis().then((hasCrisis) => {
              if (hasCrisis) {
                setCrisisAlert(true);
              }
            });
          }, 60000); // Check every minute

          // Make sure panel is hidden initially
          setShowAiPanel(false); // Commented out for diagnostics

          return () => clearInterval(crisisCheckInterval);
        }, []);

        React.useEffect(() => {
          const timerId = setInterval(() => {
            setCurrentTime(new Date());
          }, 1000);
          return () => clearInterval(timerId);
        }, []);

        const supplierOptions = [
          "Puszki&S≈Çoiki S.A.",
          "SharkIT",
          "MedykTrans",
          "RolnikLokalny",
        ];

        // Use resource data from the external mock file
        const mockResources = mockData.resources;

        // Use population zones data from the external mock file
        const populationZones = mockData.populationZones;

        // Function to create custom DivIcons - UPDATED
        const getCustomIcon = (type) => {
          let color = "gray";
          let iconHtml = "";

          switch (type) {
            case "institution":
              color = "#3498db";
              break; // Blue
            case "storage":
              color = "#2ecc71";
              break; // Green
            case "emergency_service":
              color = "#e74c3c";
              break; // Red
            case "mobile_unit":
              color = "#f39c12";
              break; // Orange
            case "shelter":
              color = "#8e44ad";
              break; // Purple
            case "medical_point":
              color = "#e91e63";
              break; // Pink/Crimson
            case "alert":
              return L.divIcon({
                className: "custom-div-icon",
                html: '<div style="background-color: #f1c40f; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px #f1c40f;"></div>',
                iconSize: [20, 20],
                iconAnchor: [10, 10],
              });
            default:
              color = "#7f8c8d";
          }

          iconHtml = `<div style="background-color: ${color}; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 3px ${color};"></div>`;
          return L.divIcon({
            className: "custom-div-icon",
            html: iconHtml,
            iconSize: [16, 16],
            iconAnchor: [8, 8],
          });
        };

        React.useEffect(() => {
          if (
            activeTab === "dashboard" &&
            mapContainerRef.current &&
            !mapRef.current
          ) {
            const map = L.map(mapContainerRef.current).setView(
              [51.367, 19.367],
              12
            );
            mapRef.current = map;

            const osmLayer = L.tileLayer(
              "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
              {
                attribution:
                  '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
              }
            );
            const satelliteLayer = L.tileLayer(
              "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
              {
                attribution:
                  "Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community",
              }
            );
            const roadsLayer = L.tileLayer(
              "https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",
              {
                attribution:
                  'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)',
              }
            );
            osmLayer.addTo(map);

            const baseMaps = {
              Standard: osmLayer,
              Satelita: satelliteLayer,
              "Drogi i Teren": roadsLayer,
            };

            // --- Overlay Layers (Data Layers) --- UPDATED
            const energeticsLayer = L.layerGroup();
            const techWaterLayer = L.layerGroup();
            const potableWaterLayer = L.layerGroup();
            const consumerFoodLayer = L.layerGroup();
            const agriFoodLayer = L.layerGroup();
            const infrastructureLayer = L.layerGroup(); // New
            const medicalLayer = L.layerGroup(); // New
            const otherResourcesLayer = L.layerGroup();
            const populationDensityLayer = L.layerGroup(); // New

            // Populate populationDensityLayer
            populationZones.forEach((zone) => {
              let zoneColor = "gray";
              let zoneOpacity = 0.3;
              let fontWeight = 1;
              switch (zone.density) {
                case "high":
                  zoneColor = "#d32f2f";
                  zoneOpacity = 0.4;
                  fontWeight = 2;
                  break; // Darker Red
                case "medium":
                  zoneColor = "#f57c00";
                  zoneOpacity = 0.3;
                  break; // Darker Orange
                case "low":
                  zoneColor = "#fbc02d";
                  zoneOpacity = 0.2;
                  break; // Darker Yellow
              }
              L.circle([zone.lat, zone.lng], {
                color: zoneColor, // Border color
                fillColor: zoneColor, // Fill color
                fillOpacity: zoneOpacity,
                radius: zone.radius,
                weight: fontWeight, // Border weight
              })
                .bindPopup(
                  `<b>${zone.name}</b><br/>Gƒôsto≈õƒá zaludnienia: ${zone.density}`
                )
                .addTo(populationDensityLayer);
            });

            mockResources.forEach((resource) => {
              const icon = getCustomIcon(resource.type);
              let markerOrCircle;
              // UPDATED Popup Content
              let popupContent = `<b>${resource.name}</b><br/>Typ: ${resource.type}`;
              if (resource.capacity !== undefined) {
                popupContent += `<br/>Pojemno≈õƒá: ${resource.capacity}${
                  resource.type === "mobile_unit" ? "L" : " os√≥b"
                }`;
              }
              if (resource.fillLevel !== undefined) {
                popupContent += `<br/>Nape≈Çnienie: ${resource.fillLevel}%`;
              }
              if (resource.staff !== undefined) {
                popupContent += `<br/>Personel: ${resource.staff}`;
              }
              if (resource.notes) {
                // Example if you add notes later
                popupContent += `<br/>Notatki: ${resource.notes}`;
              }

              if (resource.type === "alert") {
                markerOrCircle = L.circle([resource.lat, resource.lng], {
                  color: "#f1c40f",
                  fillColor: "#f1c40f",
                  fillOpacity: 0.3,
                  radius: 300,
                }).bindPopup(popupContent); // Use updated popupContent
              } else {
                markerOrCircle = L.marker([resource.lat, resource.lng], {
                  icon: icon,
                }).bindPopup(popupContent); // Use updated popupContent
              }

              // Add to appropriate category layer - UPDATED
              switch (resource.category) {
                case "energetics":
                  markerOrCircle.addTo(energeticsLayer);
                  break;
                case "technical_water":
                  markerOrCircle.addTo(techWaterLayer);
                  break;
                case "potable_water":
                  markerOrCircle.addTo(potableWaterLayer);
                  break;
                case "consumer_food":
                  markerOrCircle.addTo(consumerFoodLayer);
                  break;
                case "agricultural_food":
                  markerOrCircle.addTo(agriFoodLayer);
                  break;
                case "infrastructure":
                  markerOrCircle.addTo(infrastructureLayer);
                  break; // New
                case "medical":
                  markerOrCircle.addTo(medicalLayer);
                  break; // New
                default:
                  markerOrCircle.addTo(otherResourcesLayer);
              }
            });

            // Add default layers to map - UPDATED
            energeticsLayer.addTo(map);
            potableWaterLayer.addTo(map);
            consumerFoodLayer.addTo(map);
            infrastructureLayer.addTo(map); // Show new layer by default
            medicalLayer.addTo(map); // Show new layer by default
            populationDensityLayer.addTo(map); // Show heatmap by default
            // otherResourcesLayer.addTo(map);

            // UPDATED overlayMaps
            const overlayMaps = {
              Energetyka: energeticsLayer,
              "Woda Techniczna": techWaterLayer,
              "Woda Pitna": potableWaterLayer,
              "≈ªywno≈õƒá Konsumencka": consumerFoodLayer,
              "≈ªywno≈õƒá Rolna": agriFoodLayer,
              "Infrastruktura Kryt.": infrastructureLayer, // New
              "Punkty Medyczne": medicalLayer, // New
              "Pozosta≈Çe Zasoby": otherResourcesLayer,
              "Gƒôsto≈õƒá Zaludnienia (Sym.)": populationDensityLayer, // New
            };

            if (layerControlRef.current) {
              layerControlRef.current.remove();
            }
            layerControlRef.current = L.control
              .layers(baseMaps, overlayMaps)
              .addTo(map);
          }

          return () => {
            if (mapRef.current) {
              if (layerControlRef.current) {
                layerControlRef.current.remove();
                layerControlRef.current = null;
              }
              mapRef.current.remove();
              mapRef.current = null;
            }
          };
        }, [activeTab]);

        // Use demographic data from the external mock file
        const demographicData = mockData.demographic;

        const resources = [
          {
            id: 1,
            name: "Agregat prƒÖdotw√≥rczy 5kW",
            category: "Sprzƒôt",
            status: "sprawny",
            location: "Magazyn A1",
            responsible: "Jan Kowalski",
            nextInspection: "2025-06-15",
          },
          {
            id: 2,
            name: "Woda pitna (1000L)",
            category: "Zasoby",
            status: "dostƒôpny",
            location: "Magazyn B2",
            responsible: "Maria Nowak",
            nextInspection: "2025-05-20",
          },
          {
            id: 3,
            name: "Radiostacja VHF",
            category: "Sprzƒôt",
            status: "w_naprawie",
            location: "Punkt serwisowy",
            responsible: "Piotr Wi≈õniewski",
            nextInspection: "-",
          },
          {
            id: 4,
            name: "Namiot ratowniczy (6-osobowy)",
            category: "Infrastruktura",
            status: "w_u≈ºyciu",
            location: "OSP Stradom",
            responsible: "Anna Kowal",
            nextInspection: "2025-07-30",
          },
        ];

        const getStatusColor = (status) => {
          switch (status) {
            case "sprawny":
            case "dostƒôpny":
              return "bg-green-100 text-green-800";
            case "w_u≈ºyciu":
              return "bg-blue-100 text-blue-800";
            case "w_naprawie":
              return "bg-red-100 text-red-800";
            default:
              return "bg-gray-100 text-gray-800";
          }
        };

        const statusLabels = {
          sprawny: "Sprawny",
          dostƒôpny: "Dostƒôpny",
          w_u≈ºyciu: "W u≈ºyciu",
          w_naprawie: "W naprawie",
        };

        // Icons for local admin dashboard
        const ChevronRightIcon = () => (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
        );

        const MenuIcon = () => (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
        );

        const ShoppingCartIcon = () => (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <circle cx="9" cy="21" r="1"></circle>
            <circle cx="20" cy="21" r="1"></circle>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
          </svg>
        );

        const PackageIcon = () => (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line>
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
            <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
            <line x1="12" y1="22.08" x2="12" y2="12"></line>
          </svg>
        );

        const RefreshCwIcon = () => (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <polyline points="23 4 23 10 17 10"></polyline>
            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
          </svg>
        );

        const BarChart3Icon = () => (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <line x1="12" y1="20" x2="12" y2="10"></line>
            <line x1="18" y1="20" x2="18" y2="4"></line>
            <line x1="6" y1="20" x2="6" y2="16"></line>
          </svg>
        );

        const CheckCircleIcon = () => (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="40"
            height="40"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
        );

        const BellIcon = () => (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="40"
            height="40"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"></path>
            <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"></path>
          </svg>
        );

        const ScaleIcon = () => (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="40"
            height="40"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"></path>
            <path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"></path>
            <path d="M7 21h10"></path>
            <path d="M12 3v18"></path>
            <path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"></path>
          </svg>
        );

        const DownloadIcon = () => (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
        );

        const NavigationIcon = () => (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <polygon points="3 11 22 2 13 21 11 13 3 11"></polygon>
          </svg>
        );

        const MapPinIcon = () => (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path>
            <circle cx="12" cy="10" r="3"></circle>
          </svg>
        );

        const TruckIcon = () => (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <path d="M5 18H3c-.55 0-1-.45-1-1V8c0-.55.45-1 1-1h7l3-3h9l-1 1v11c0 .55-.45 1-1 1h-2"></path>
            <circle cx="5" cy="18" r="2"></circle>
            <circle cx="19" cy="18" r="2"></circle>
          </svg>
        );

        const PlusCircleIcon = () => (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="16"></line>
            <line x1="8" y1="12" x2="16" y2="12"></line>
          </svg>
        );

        const EyeIcon = () => (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
        );

        const Edit2Icon = () => (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path>
            <path d="m15 5 4 4"></path>
          </svg>
        );

        const CalendarIcon = () => (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
        );

        const FileTextIcon = () => (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10 9 9 9 8 9"></polyline>
          </svg>
        );

        const UploadIcon = () => (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
        );

        const UserCheckIcon = () => (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <polyline points="16 11 18 13 22 9"></polyline>
          </svg>
        );

        // Key indicators - simplified for this example
        const KeyIndicators = () => {
          return (
            <div className="p-6 bg-white rounded-lg shadow">
              <h3 className="text-lg font-semibold text-gray-700 mb-4">
                Kluczowe Wska≈∫niki Gminy Be≈Çchat√≥w
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="p-4 bg-blue-50 rounded-lg">
                  <p className="text-sm text-blue-600 font-semibold">
                    Liczba Mieszka≈Ñc√≥w (2021)
                  </p>
                  <p className="text-2xl font-bold text-blue-800">11,539</p>
                </div>
                <div className="p-4 bg-green-50 rounded-lg">
                  <p className="text-sm text-green-600 font-semibold">
                    Szacowani Tury≈õci (Lipiec)
                  </p>
                  <p className="text-2xl font-bold text-green-800">
                    500 - 1,500 (szac.)
                  </p>
                  <button
                    onClick={() =>
                      alert("Wy≈õwietlanie wykresu turyst√≥w - do implementacji")
                    }
                    className="mt-2 px-3 py-1.5 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition duration-150"
                  >
                    Poka≈º wykres turyst√≥w
                  </button>
                </div>
                <div className="p-4 bg-yellow-50 rounded-lg">
                  <p className="text-sm text-yellow-600 font-semibold">
                    Aktywne Zasoby Kryzysowe
                  </p>
                  <p className="text-2xl font-bold text-yellow-800">
                    {mockResources.length}
                  </p>
                </div>
                <div className="p-4 bg-red-50 rounded-lg">
                  <p className="text-sm text-red-600 font-semibold">
                    Alerty Wysokiego Ryzyka
                  </p>
                  <p className="text-2xl font-bold text-red-800">
                    {mockResources.filter((r) => r.type === "alert").length}
                  </p>
                </div>
              </div>
            </div>
          );
        };

        const addNewPurchaseRow = () => {
          setPurchases([
            ...purchases,
            {
              id: Date.now(), // Use timestamp for unique ID
              supplier: "",
              buyer: "Gmina Be≈Çchat√≥w",
              item: "",
              quantity: "",
              isAiInput: false,
              canJoin: false, // Local purchases don't need "Do≈ÇƒÖcz" button
              isJoined: true, // For local purchases, quantity field is directly available
            },
          ]);
        };

        const handlePurchaseChange = (id, field, value) => {
          setPurchases(
            purchases.map((p) => (p.id === id ? { ...p, [field]: value } : p))
          );
        };

        const checkFireAlarmCondition = (purchaseId, itemValue) => {
          // Only trigger for the third line potentially, or based on itemValue for any new item
          const triggeringPurchase = purchases.find((p) => p.id === purchaseId);
          // Example: trigger if it's a newly added row (not the first one) and item matches
          if (
            triggeringPurchase &&
            purchaseId !== 1 &&
            itemValue &&
            itemValue.toLowerCase().includes("obs≈Çuga systemu")
          ) {
            // Check if this is the 3rd row overall, or a more robust condition
            const nonDefaultPurchases = purchases.filter((p) => p.id !== 1);
            if (purchases.length >= 3) {
              // Simple check if it's the 3rd+ row
              setCrisisAlert(true);
            }
          }
        };

        // Create a fallback for realAI if it doesn't exist
        if (typeof window.realAI === "undefined") {
          console.log(
            "Creating fallback for realAI in resource-monitoring-home.html"
          );
          window.realAI = window.mockAI || {
            getConversationLog: async (contextType) => {
              console.log(
                "Using fallback realAI.getConversationLog in resource-monitoring-home.html"
              );
              return [
                {
                  role: "assistant",
                  content:
                    "Witaj! Jestem w trybie awaryjnym. Niekt√≥re funkcje mogƒÖ byƒá niedostƒôpne.",
                  timestamp: new Date().toISOString(),
                },
              ];
            },
            addMessage: async (role, content, contextType) => {
              console.log(
                "Using fallback realAI.addMessage in resource-monitoring-home.html"
              );
              return [
                {
                  role,
                  content,
                  timestamp: new Date().toISOString(),
                },
              ];
            },
            getResponse: async (userInput) => {
              console.log(
                "Using fallback realAI.getResponse in resource-monitoring-home.html"
              );
              return "Przepraszam, dzia≈Çam w trybie awaryjnym. Spr√≥buj od≈õwie≈ºyƒá stronƒô lub skontaktuj siƒô z administratorem.";
            },
          };
        }

        const toggleAiPanel = (contextType, resourceInfo = {}) => {
          console.log(
            "toggleAiPanel called. Current showAiPanel:",
            showAiPanel,
            "Context:",
            contextType
          );

          // If no contextType is provided, default to freestyle (real AI)
          const effectiveContextType = contextType || "freestyle";
          const isFreestyleMode = effectiveContextType === "freestyle";

          // Toggle panel if already showing with the same context
          if (
            showAiPanel &&
            currentAiContext &&
            currentAiContext.type === effectiveContextType
          ) {
            setShowAiPanel(false);
            console.log("Setting showAiPanel to false");
            return;
          }

          // If panel is hidden, or context is different, show it
          setShowAiPanel(true);
          console.log("Setting showAiPanel to true");

          // Create context based on resource info and context type
          const context = {
            type: effectiveContextType,
            resourceName: resourceInfo.name || "zasobu",
            resourceType: resourceInfo.category || "general",
            gminaName: resourceInfo.gmina || "Be≈Çchat√≥w",
            purchaseId: resourceInfo.purchaseId,
            // For freestyle mode, set mockCompleted to true to use realAI immediately
            // For other modes, set to false to start with mockAI
            mockCompleted: isFreestyleMode ? true : false,
            data: resourceInfo, // Store any additional context data
          };

          setCurrentAiContext(context);

          // For freestyle mode, we skip suggestions and analysis plan
          if (!isFreestyleMode) {
            // Use mockAI to get suggestions (only for mock modes)
            mockAI.getSuggestions(context, 3).then((suggestions) => {
              setAiSuggestions(
                suggestions.map((s) => ({
                  label: s.title,
                  value: s.id,
                  description: s.description,
                }))
              );
            });

            // Determine scenario based on context type (only for mock modes)
            let scenarioType = effectiveContextType;

            // Map generic types to more specific scenarios
            if (scenarioType === "resources") {
              if (context.resourceType === "energetics") {
                scenarioType = "powerOutage";
              } else if (
                context.resourceType === "water" ||
                context.resourceType === "technical_water"
              ) {
                scenarioType = "waterShortage";
              } else if (context.resourceType === "shelter") {
                scenarioType = "evacuation";
              } else {
                scenarioType = "resources";
              }
            }

            // Get analysis plan based on scenario type (only for mock modes)
            mockAI.getAnalysisPlan(scenarioType).then((plan) => {
              setAiAnalysisPlan(plan.map((step) => step.description));
            });

            // Load conversation history with the appropriate context from mockAI
            mockAI.getConversationLog(effectiveContextType).then((log) => {
              setAiAssistantLog(
                log.map((entry) => ({
                  sender: entry.role === "assistant" ? "ai" : entry.role,
                  message: entry.content,
                  timestamp: entry.timestamp
                    ? new Date(entry.timestamp).toLocaleTimeString([], {
                        hour: "2-digit",
                        minute: "2-digit",
                      })
                    : "",
                }))
              );
            });
          } else {
            // For freestyle mode, clear the suggestions and analysis plan
            setAiSuggestions([]);
            setAiAnalysisPlan([]);

            // Load conversation from realAI
            realAI.getConversationLog(effectiveContextType).then((log) => {
              setAiAssistantLog(
                log.map((entry) => ({
                  sender: entry.role === "assistant" ? "ai" : entry.role,
                  message: entry.content,
                  timestamp: entry.timestamp
                    ? new Date(entry.timestamp).toLocaleTimeString([], {
                        hour: "2-digit",
                        minute: "2-digit",
                      })
                    : "",
                }))
              );
            });
          }
        };

        const applyAiSuggestion = (value) => {
          if (currentAiContext) {
            const { purchaseId, type, resourceName } = currentAiContext;

            // Handle different suggestion types
            let suggestionText = "";
            if (type === "generators" || type === "resources") {
              suggestionText = `Zastosowano sugestiƒô dla ${
                resourceName || "zasobu"
              }`;
            } else if (type === "cans" && typeof value === "object") {
              suggestionText = `Miƒôsne: ${value.meat}, Warzywne: ${value.veg}`;
            } else {
              suggestionText = `Zastosowano sugestiƒô: ${value}`;
            }

            // Update purchases if applicable
            if (purchaseId) {
              setPurchases(
                purchases.map((p) =>
                  p.id === purchaseId
                    ? { ...p, quantity: String(value), isAiInput: false }
                    : p
                )
              );
            }

            // Add user message to the conversation log
            mockAI
              .addMessage(
                "user",
                `Zaakceptowano sugestiƒô: ${suggestionText}`,
                currentAiContext.type
              )
              .then((updatedLog) => {
                // Transform the log format to match the application's format
                setAiAssistantLog(
                  updatedLog.map((entry) => ({
                    sender: entry.role === "assistant" ? "ai" : entry.role,
                    message: entry.content,
                    timestamp: entry.timestamp
                      ? new Date(entry.timestamp).toLocaleTimeString([], {
                          hour: "2-digit",
                          minute: "2-digit",
                        })
                      : "", // Added formatting
                  }))
                );
              });

            setShowAiPanel(false); // Close panel after accepting
          }
        };

        const handleAiAction = (actionType, value) => {
          if (actionType === "accept_suggestion") {
            applyAiSuggestion(value);
          } else if (actionType === "accept_suggestion_cans") {
            applyAiSuggestion(value); // Value is an object {meat: X, veg: Y}
          } else if (actionType === "send_message") {
            // First, check if we should use realAI instead of mockAI
            const useRealAI =
              currentAiContext?.type === "freestyle" ||
              currentAiContext?.mockCompleted === true;

            // Determine which AI module to use
            const aiModule = useRealAI ? window.realAI : window.mockAI;

            if (useRealAI) {
              // Get the demographic data for context enhancement
              mockAPI.demographic.get().then((demographicData) => {
                // Get current conversation history
                realAI
                  .getConversationLog(currentAiContext?.type || "freestyle")
                  .then((history) => {
                    // Add user message to the log first
                    realAI
                      .addMessage(
                        "user",
                        value,
                        currentAiContext?.type || "freestyle",
                        history
                      )
                      .then((updatedLog) => {
                        // Update the UI immediately with the user message
                        setAiAssistantLog(
                          updatedLog.map((entry) => ({
                            sender:
                              entry.role === "assistant" ? "ai" : entry.role,
                            message: entry.content,
                            timestamp: entry.timestamp
                              ? new Date(entry.timestamp).toLocaleTimeString(
                                  [],
                                  {
                                    hour: "2-digit",
                                    minute: "2-digit",
                                  }
                                )
                              : "",
                          }))
                        );

                        // Get response from AI
                        realAI
                          .getResponse(value, updatedLog, {
                            demographic: demographicData,
                            contextType: currentAiContext?.type || "freestyle",
                            resourceInfo: currentAiContext?.resourceName
                              ? {
                                  name: currentAiContext.resourceName,
                                  type: currentAiContext.resourceType,
                                }
                              : null,
                          })
                          .then((response) => {
                            // Add AI response to the log
                            realAI
                              .addMessage(
                                "assistant",
                                response,
                                currentAiContext?.type || "freestyle",
                                updatedLog
                              )
                              .then((finalLog) => {
                                // Update UI with complete conversation
                                setAiAssistantLog(
                                  finalLog.map((entry) => ({
                                    sender:
                                      entry.role === "assistant"
                                        ? "ai"
                                        : entry.role,
                                    message: entry.content,
                                    timestamp: entry.timestamp
                                      ? new Date(
                                          entry.timestamp
                                        ).toLocaleTimeString([], {
                                          hour: "2-digit",
                                          minute: "2-digit",
                                        })
                                      : "",
                                  }))
                                );
                              });
                          });
                      });
                  });
              });
            } else {
              // Use mockAI for scripted contextual responses
              mockAI.getResponse(value, currentAiContext.type).then(() => {
                // After getResponse completes, the log in localStorage (for the current context) is fully updated.
                // Now, fetch that complete log and update the React state.
                mockAI.getConversationLog(currentAiContext.type).then((log) => {
                  // Define different thresholds for different context types
                  let mockScriptThreshold = 6; // Default threshold

                  // We can define custom thresholds for specific scripts if needed
                  if (currentAiContext?.type === "generators") {
                    mockScriptThreshold = 6;
                  } else if (currentAiContext?.type === "cans") {
                    mockScriptThreshold = 8;
                  } else if (currentAiContext?.type === "emergency") {
                    mockScriptThreshold = 5;
                  }

                  // Check if this is the last message in the mock script
                  const isLastMockMessage =
                    currentAiContext?.type !== "freestyle" &&
                    log.length >= mockScriptThreshold;

                  // If this is the last message, set a flag to transition to realAI for future messages
                  if (isLastMockMessage) {
                    setCurrentAiContext((prev) => ({
                      ...prev,
                      mockCompleted: true,
                    }));
                  }

                  // Update the UI
                  setAiAssistantLog(
                    log.map((entry) => ({
                      sender: entry.role === "assistant" ? "ai" : entry.role,
                      message: entry.content,
                      timestamp: entry.timestamp
                        ? new Date(entry.timestamp).toLocaleTimeString([], {
                            hour: "2-digit",
                            minute: "2-digit",
                          })
                        : "",
                    }))
                  );
                });
              });
            }
          }
        };

        // Function to handle user input in the AI assistant chat
        const handleAiChatInput = (e) => {
          if (e.key === "Enter" && e.target.value.trim()) {
            const userMessage = e.target.value.trim();
            handleAiAction("send_message", userMessage);
            e.target.value = ""; // Clear input field
          }
        };

        const startResize = (mouseDownEvent) => {
          setIsResizing(true);
          const startX = mouseDownEvent.clientX;
          const startWidth = aiPanelWidth;

          const doDrag = (mouseMoveEvent) => {
            const newWidth = startWidth - (mouseMoveEvent.clientX - startX);
            if (newWidth > 250 && newWidth < window.innerWidth * 0.8) {
              // Min/max width
              setAiPanelWidth(newWidth);
            }
          };

          const stopDrag = () => {
            document.removeEventListener("mousemove", doDrag, false);
            document.removeEventListener("mouseup", stopDrag, false);
            setIsResizing(false);
          };

          document.addEventListener("mousemove", doDrag, false);
          document.addEventListener("mouseup", stopDrag, false);
        };

        return (
          <div className="min-h-screen bg-gray-50 flex">
            {/* Floating AI Assistant Button */}
            <button
              className="ai-floating-button"
              onClick={() => {
                // If panel is not open, open it in freestyle mode (direct to real AI)
                if (!showAiPanel) {
                  toggleAiPanel("freestyle");
                } else {
                  // If panel is open, just close it
                  setShowAiPanel(false);
                }
                console.log(
                  "Floating button clicked, new showAiPanel state is:",
                  !showAiPanel
                );
              }}
              aria-label="Asystent AI"
              title="Otw√≥rz Asystenta AI"
              style={{ boxShadow: "0px 4px 10px rgba(0, 0, 0, 0.2)" }}
            >
              <img
                src="SharkIT-assistant.png"
                alt="AI Assistant"
                onError={(e) => {
                  console.error("Failed to load SharkIT-assistant.png");
                  e.target.onerror = null;
                  e.target.style.backgroundColor = "#007bff";
                  e.target.style.color = "white";
                  e.target.style.fontWeight = "bold";
                  e.target.style.display = "flex";
                  e.target.style.alignItems = "center";
                  e.target.style.justifyContent = "center";
                  e.target.innerText = "AI";
                }}
              />
            </button>
            {/* Navigation Sidebar */}
            <div
              className={`transition-all duration-300 pt-2 pb-0 border-r border-gray-200 shadow-lg ${
                sidebarOpen ? "w-64" : "w-16"
              }`}
              style={{
                backgroundColor: "#182139",
                color: "white",
                minHeight: "100vh",
              }}
            >
              <nav className="flex flex-col h-full">
                <div>
                  {" "}
                  {/* Wrapper for menu items to push logo to bottom */}
                  <button
                    onClick={() => setCurrentView("home")}
                    className="w-full flex items-center px-4 py-3 text-white transition-colors hover:bg-blue-800"
                  >
                    <HomeIcon />
                    {sidebarOpen && <span className="ml-3">Menu g≈Ç√≥wne</span>}
                  </button>
                  <button
                    onClick={() => setActiveTab("dashboard")}
                    className={`w-full flex items-center px-4 py-3 text-white transition-colors ${
                      activeTab === "dashboard"
                        ? "bg-blue-500"
                        : "hover:bg-blue-800"
                    }`}
                  >
                    <NavigationIcon />
                    {sidebarOpen && <span className="ml-3">Mapa gminy</span>}
                  </button>
                  <button
                    onClick={() => setActiveTab("demographic")}
                    className={`w-full flex items-center px-4 py-3 text-white transition-colors ${
                      activeTab === "demographic"
                        ? "bg-blue-500"
                        : "hover:bg-blue-800"
                    }`}
                  >
                    <UserCheckIcon />
                    {sidebarOpen && (
                      <span className="ml-3">Informacje demograficzne</span>
                    )}
                  </button>
                  <button
                    onClick={() => setActiveTab("purchase-planning")}
                    className={`w-full flex items-center px-4 py-3 text-white transition-colors ${
                      activeTab === "purchase-planning"
                        ? "bg-blue-500"
                        : "hover:bg-blue-800"
                    }`}
                  >
                    <BriefcaseIcon />
                    {sidebarOpen && (
                      <span className="ml-3">Planowanie zakup√≥w</span>
                    )}
                  </button>
                  <button
                    onClick={() => setActiveTab("resources")}
                    className={`w-full flex items-center px-4 py-3 text-white transition-colors ${
                      activeTab === "resources"
                        ? "bg-blue-500"
                        : "hover:bg-blue-800"
                    }`}
                  >
                    <ShoppingCartIcon />
                    {sidebarOpen && (
                      <span className="ml-3">Zapotrzebowanie</span>
                    )}
                  </button>
                  <button
                    onClick={() => setActiveTab("storage")}
                    className={`w-full flex items-center px-4 py-3 text-white transition-colors ${
                      activeTab === "storage"
                        ? "bg-blue-500"
                        : "hover:bg-blue-800"
                    }`}
                  >
                    <PackageIcon />
                    {sidebarOpen && <span className="ml-3">Magazynowanie</span>}
                  </button>
                  <button
                    onClick={() => setActiveTab("inventory")}
                    className={`w-full flex items-center px-4 py-3 text-white transition-colors ${
                      activeTab === "inventory"
                        ? "bg-blue-500"
                        : "hover:bg-blue-800"
                    }`}
                  >
                    <RefreshCwIcon />
                    {sidebarOpen && <span className="ml-3">Remanent</span>}
                  </button>
                  <button
                    onClick={() => setActiveTab("reports")}
                    className={`w-full flex items-center px-4 py-3 text-white transition-colors ${
                      activeTab === "reports"
                        ? "bg-blue-500"
                        : "hover:bg-blue-800"
                    }`}
                  >
                    <BarChart3Icon />
                    {sidebarOpen && <span className="ml-3">Raporty</span>}
                  </button>
                </div>

                {/* SharkIT Logo at the bottom */}
                <div className="mt-auto mb-0 flex justify-center px-1 py-1">
                  {sidebarOpen ? (
                    <img
                      src="SharkIT white.png"
                      alt="SharkIT Logo"
                      className="w-full h-auto object-contain"
                    />
                  ) : (
                    <img
                      src="SharkIT white.png"
                      alt="SharkIT Logo"
                      className="w-full h-auto max-w-14 object-contain"
                    />
                  )}
                </div>
              </nav>
            </div>

            {/* Main Content */}
            <div className="flex-1">
              {/* Header */}
              <header className="bg-white border-b border-gray-200 px-6 py-4">
                <div className="flex items-center justify-between">
                  <div className="flex items-center">
                    <button
                      onClick={() => setSidebarOpen(!sidebarOpen)}
                      className="p-2 rounded hover:bg-gray-100"
                    >
                      <MenuIcon />
                    </button>
                    <h2 className="ml-4 text-xl font-semibold text-gray-800">
                      Centrum Zasob√≥w Gminy - Gmina Be≈Çchat√≥w
                    </h2>
                  </div>
                  <div className="flex items-center space-x-4">
                    <span className="text-sm text-gray-600">
                      {currentTime.toLocaleDateString("pl-PL", {
                        day: "numeric",
                        month: "long",
                        year: "numeric",
                      })}
                      , {currentTime.toLocaleTimeString("pl-PL")}
                    </span>
                  </div>
                </div>
              </header>

              {/* Content Area */}
              <main className="p-6">
                {activeTab === "dashboard" && (
                  <div className="space-y-6">
                    {/* Quick Stats */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                      <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-sm text-gray-600">Ludno≈õƒá</p>
                            <p className="text-2xl font-bold text-gray-800">
                              {demographicData.residents.toLocaleString()}
                              <span className="text-blue-500">
                                {" "}
                                / {demographicData.tourists.toLocaleString()}
                              </span>
                            </p>
                            <button
                              onClick={() => setActiveTab("demographic")}
                              className="text-xs text-blue-600 hover:underline mt-1"
                            >
                              Zobacz szczeg√≥≈Çy
                            </button>
                          </div>
                          <UsersIcon />
                        </div>
                      </div>

                      <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-sm text-gray-600">
                              Zasoby sprawne
                            </p>
                            <p className="text-2xl font-bold text-gray-800">
                              127 / 156
                            </p>
                          </div>
                          <CheckCircleIcon />
                        </div>
                      </div>

                      <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-sm text-gray-600">
                              Aktywne alerty
                            </p>
                            <p className="text-2xl font-bold text-gray-800">
                              3
                            </p>
                          </div>
                          <BellIcon />
                        </div>
                      </div>

                      <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-sm text-gray-600">
                              Zapasy na dni
                            </p>
                            <p className="text-2xl font-bold text-gray-800">
                              5.2
                            </p>
                          </div>
                          <ScaleIcon />
                        </div>
                      </div>
                    </div>

                    {/* Main Map Area */}
                    <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                      <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-semibold text-gray-800">
                          Mapa zasob√≥w gminy
                        </h3>
                        <div className="flex space-x-2">
                          <button className="flex items-center px-3 py-1 text-sm bg-gray-100 rounded-lg hover:bg-gray-200">
                            <NavigationIcon />
                            <span className="ml-1">Wy≈õrodkuj</span>
                          </button>
                          <button className="flex items-center px-3 py-1 text-sm bg-gray-100 rounded-lg hover:bg-gray-200">
                            <MapPinIcon />
                            <span className="ml-1">Dodaj marker</span>
                          </button>
                        </div>
                      </div>

                      {/* Placeholder for map */}
                      <div
                        className="relative h-96 bg-gray-100 rounded-lg overflow-hidden"
                        ref={mapContainerRef}
                        id="mapid"
                        style={{ height: "400px" }}
                      >
                        {/* Map markers and content from original code - REMOVED as Leaflet will render the map */}
                      </div>
                    </div>

                    {/* Legend and filters */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                        <h4 className="font-medium text-gray-700 mb-3">
                          Legenda
                        </h4>
                        <div className="grid grid-cols-2 gap-3">
                          <div className="flex items-center">
                            <div className="w-4 h-4 bg-blue-600 rounded-full mr-2"></div>
                            <span className="text-sm text-gray-600">
                              Instytucje
                            </span>
                          </div>
                          <div className="flex items-center">
                            <div className="w-4 h-4 bg-green-600 rounded-full mr-2"></div>
                            <span className="text-sm text-gray-600">
                              Magazyny
                            </span>
                          </div>
                          <div className="flex items-center">
                            <div className="w-4 h-4 bg-red-600 rounded-full mr-2"></div>
                            <span className="text-sm text-gray-600">
                              S≈Çu≈ºby ratownicze
                            </span>
                          </div>
                          <div className="flex items-center">
                            <div className="w-4 h-4 bg-orange-600 rounded-full mr-2"></div>
                            <span className="text-sm text-gray-600">
                              Jednostki mobilne
                            </span>
                          </div>
                        </div>
                      </div>

                      <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                        <h4 className="font-medium text-gray-700 mb-3">
                          Szybkie akcje
                        </h4>
                        <div className="space-y-2">
                          <button className="w-full flex items-center justify-center px-4 py-2 text-sm bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                            <MapPinIcon />
                            <span className="ml-2">Dodaj nowy zas√≥b</span>
                          </button>
                          <button className="w-full flex items-center justify-center px-4 py-2 text-sm bg-green-100 text-green-700 rounded hover:bg-green-200">
                            <RefreshCwIcon />
                            <span className="ml-2">Rozpocznij remanent</span>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {activeTab === "demographic" && (
                  <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                      <h3 className="text-lg font-semibold text-gray-800 mb-4">
                        Informacje demograficzne
                      </h3>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div className="space-y-4">
                          <div className="flex items-center justify-between p-4 bg-gray-50 rounded">
                            <div className="flex items-center">
                              <UsersIcon />
                              <span className="ml-3 text-gray-600">
                                Mieszka≈Ñcy stali
                              </span>
                            </div>
                            <span className="font-semibold text-gray-800">
                              {demographicData.residents.toLocaleString()}
                            </span>
                          </div>
                          <div className="flex items-center justify-between p-4 bg-gray-50 rounded">
                            <div className="flex items-center">
                              <UsersIcon />
                              <span className="ml-3 text-gray-600">
                                Szacowana liczba turyst√≥w
                              </span>
                            </div>
                            <span className="font-semibold text-gray-800">
                              {demographicData.tourists.toLocaleString()}
                            </span>
                          </div>
                        </div>
                        <div className="space-y-4">
                          <div className="flex items-center justify-between p-4 bg-gray-50 rounded">
                            <div className="flex items-center">
                              <UserCheckIcon />
                              <span className="ml-3 text-gray-600">
                                Zarejestrowani wyborcy
                              </span>
                            </div>
                            <span className="font-semibold text-gray-800">
                              {demographicData.registeredVoters.toLocaleString()}
                            </span>
                          </div>
                          <div className="flex items-center justify-between p-4 bg-gray-50 rounded">
                            <div className="flex items-center">
                              <PackageIcon />
                              <span className="ml-3 text-gray-600">
                                Instytucje publiczne
                              </span>
                            </div>
                            <span className="font-semibold text-gray-800">
                              {demographicData.publicInstitutions}
                            </span>
                          </div>
                        </div>
                      </div>

                      {/* Population Increase Info */}
                      <div className="mt-6 pt-6 border-t border-gray-200">
                        <h4 className="text-md font-semibold text-gray-700 mb-4">
                          Okresowe wzrosty liczby ludno≈õci (wizualizacja
                          szacunkowa)
                        </h4>
                        <div className="space-y-6">
                          {/* Summer Months */}
                          <div>
                            <p className="text-sm font-medium text-gray-700 mb-1">
                              MiesiƒÖce letnie (Czerwiec - Sierpie≈Ñ)
                            </p>
                            <div className="flex items-end justify-around h-32 bg-gray-100 p-2 rounded-lg">
                              {/* Czerwiec */}
                              <div className="flex flex-col items-center w-16">
                                <p className="text-xs font-semibold text-blue-700">
                                  ~+10%
                                </p>
                                <div
                                  className="bg-blue-300 h-12 w-full rounded-sm mt-1"
                                  title="Czerwiec: Szacunkowy wzrost o 10%"
                                ></div>
                                <p className="text-xs text-center text-gray-600 mt-1">
                                  Cze
                                </p>
                              </div>
                              {/* Lipiec */}
                              <div className="flex flex-col items-center w-16">
                                <p className="text-xs font-semibold text-blue-700">
                                  ~+18%
                                </p>
                                <div
                                  className="bg-blue-400 h-16 w-full rounded-sm mt-1"
                                  title="Lipiec: Szacunkowy wzrost o 15-20%"
                                ></div>
                                <p className="text-xs text-center text-gray-600 mt-1">
                                  Lip
                                </p>
                              </div>
                              {/* Sierpie≈Ñ */}
                              <div className="flex flex-col items-center w-16">
                                <p className="text-xs font-semibold text-blue-700">
                                  ~+18%
                                </p>
                                <div
                                  className="bg-blue-400 h-16 w-full rounded-sm mt-1"
                                  title="Sierpie≈Ñ: Szacunkowy wzrost o 15-20%"
                                ></div>
                                <p className="text-xs text-center text-gray-600 mt-1">
                                  Sie
                                </p>
                              </div>
                            </div>
                            <p className="text-xs text-gray-500 mt-1">
                              Wzrost liczby turyst√≥w, popularna agroturystyka i
                              wydarzenia lokalne.
                            </p>
                          </div>

                          {/* Holiday Periods */}
                          <div>
                            <p className="text-sm font-medium text-gray-700 mb-1">
                              Okresy ≈õwiƒÖteczne i d≈Çugie weekendy
                            </p>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                              <div className="bg-yellow-100 p-2 rounded-lg text-center flex flex-col justify-between h-28">
                                <p className="text-xs font-medium text-yellow-700">
                                  Wielkanoc
                                </p>
                                <div
                                  className="relative bg-yellow-300 h-8 w-full my-1 rounded-sm mx-auto flex items-center justify-center"
                                  title="Niewielki wzrost"
                                >
                                  <span className="text-xs font-semibold text-yellow-800">
                                    ~+5%
                                  </span>
                                </div>
                                <p className="text-xs text-yellow-600 mt-1">
                                  Przyjazdy rodzinne
                                </p>
                              </div>
                              <div className="bg-orange-100 p-2 rounded-lg text-center flex flex-col justify-between h-28">
                                <p className="text-xs font-medium text-orange-700">
                                  Maj√≥wka
                                </p>
                                <div
                                  className="relative bg-orange-400 h-10 w-full my-1 rounded-sm mx-auto flex items-center justify-center"
                                  title="ZnaczƒÖcy wzrost"
                                >
                                  <span className="text-xs font-semibold text-orange-800">
                                    ~+20%
                                  </span>
                                </div>
                                <p className="text-xs text-orange-600 mt-1">
                                  Kr√≥tkie wyjazdy
                                </p>
                              </div>
                              <div className="bg-red-100 p-2 rounded-lg text-center flex flex-col justify-between h-28">
                                <p className="text-xs font-medium text-red-700">
                                  Bo≈ºe Cia≈Ço
                                </p>
                                <div
                                  className="relative bg-red-400 h-10 w-full my-1 rounded-sm mx-auto flex items-center justify-center"
                                  title="ZnaczƒÖcy wzrost"
                                >
                                  <span className="text-xs font-semibold text-red-800">
                                    ~+20%
                                  </span>
                                </div>
                                <p className="text-xs text-red-600 mt-1">
                                  D≈Çugi weekend
                                </p>
                              </div>
                              <div className="bg-indigo-100 p-2 rounded-lg text-center flex flex-col justify-between h-28">
                                <p className="text-xs font-medium text-indigo-700">
                                  Bo≈ºe Narodz./Sylw.
                                </p>
                                <div
                                  className="relative bg-indigo-300 h-9 w-full my-1 rounded-sm mx-auto flex items-center justify-center"
                                  title="Wzrost"
                                >
                                  <span className="text-xs font-semibold text-indigo-800">
                                    ~+15%
                                  </span>
                                </div>
                                <p className="text-xs text-indigo-600 mt-1">
                                  Turystyka ≈õwiƒÖteczna
                                </p>
                              </div>
                            </div>
                          </div>

                          {/* Local Festivals */}
                          <div>
                            <p className="text-sm font-medium text-gray-700 mb-1">
                              Festiwale i wydarzenia lokalne
                            </p>
                            <div className="bg-purple-50 p-3 rounded-lg">
                              <p className="text-xs text-purple-700">
                                Nale≈ºy monitorowaƒá kalendarz wydarze≈Ñ gminnych
                                (np. do≈ºynki, festyny), kt√≥re mogƒÖ powodowaƒá
                                kr√≥tkoterminowe, znaczƒÖce wzrosty liczby os√≥b
                                przebywajƒÖcych na terenie gminy.
                                <span className="block mt-1 font-medium">
                                  Potencjalny wzrost: Zale≈ºny od skali
                                  wydarzenia.
                                </span>
                              </p>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {activeTab === "purchase-planning" && (
                  <div className="flex flex-1 overflow-hidden">
                    {" "}
                    {/* Outer flex for tab content */}
                    {/* Main Purchase Planning Content (Table Area) */}
                    <div className="flex-1 p-6 overflow-y-auto">
                      <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <div className="flex justify-between items-center mb-6">
                          <h3 className="text-lg font-semibold text-gray-800">
                            Planowanie Zakup√≥w Strategicznych
                          </h3>
                          <button
                            onClick={addNewPurchaseRow}
                            className="flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                          >
                            <PlusCircleIcon />
                            <span className="ml-2">Dodaj nowy wiersz</span>
                          </button>
                        </div>

                        <table className="w-full">
                          <thead>
                            <tr
                              style={{
                                backgroundColor: "#182139",
                                color: "white",
                              }}
                            >
                              <th className="px-4 py-3 text-left font-medium">
                                Dostawca
                              </th>
                              <th className="px-4 py-3 text-left font-medium">
                                Nabywca
                              </th>
                              <th className="px-4 py-3 text-left font-medium">
                                Co kupujemy
                              </th>
                              <th className="px-4 py-3 text-left font-medium">
                                Ilo≈õƒá
                              </th>
                            </tr>
                          </thead>
                          <tbody className="divide-y divide-gray-200">
                            {purchases.map((purchase, index) => (
                              <tr
                                key={purchase.id}
                                className={
                                  index % 2 === 0 ? "bg-white" : "bg-gray-50"
                                }
                              >
                                <td className="px-4 py-3 text-sm">
                                  {purchase.id === 1 ? (
                                    purchase.supplier
                                  ) : (
                                    <select
                                      value={purchase.supplier}
                                      onChange={(e) =>
                                        handlePurchaseChange(
                                          purchase.id,
                                          "supplier",
                                          e.target.value
                                        )
                                      }
                                      className="w-full p-1 border border-gray-300 rounded-md"
                                    >
                                      <option value="">Wybierz...</option>
                                      {supplierOptions.map((opt) => (
                                        <option key={opt} value={opt}>
                                          {opt}
                                        </option>
                                      ))}
                                    </select>
                                  )}
                                </td>
                                <td className="px-4 py-3 text-sm text-gray-700">
                                  {purchase.buyer}
                                </td>
                                <td className="px-4 py-3 text-sm">
                                  <input
                                    type="text"
                                    value={purchase.item}
                                    onChange={(e) =>
                                      handlePurchaseChange(
                                        purchase.id,
                                        "item",
                                        e.target.value
                                      )
                                    }
                                    onBlur={() =>
                                      checkFireAlarmCondition(
                                        purchase.id,
                                        purchase.item
                                      )
                                    } // Pass ID for context
                                    className="w-full p-1 border border-gray-300 rounded-md"
                                    disabled={purchase.buyer === "≈Å√≥dzkie"} // Disabled if buyer is ≈Å√≥dzkie
                                  />
                                </td>
                                <td className="px-4 py-3 text-sm">
                                  {/* If it's a foreign purchase and canJoin is true, show "Do≈ÇƒÖcz" button */}
                                  {purchase.id === 1 &&
                                  purchase.buyer === "≈Å√≥dzkie" &&
                                  purchase.canJoin ? (
                                    <button
                                      onClick={() => {
                                        setPurchases(
                                          purchases.map((p) =>
                                            p.id === purchase.id
                                              ? {
                                                  ...p,
                                                  isJoined: true,
                                                  canJoin: false,
                                                  isAiInput: true,
                                                }
                                              : p
                                          )
                                        );
                                        // Optionally trigger AI panel directly, or wait for user to click bot icon
                                        // toggleAiPanel('generators', purchase.id);
                                      }}
                                      className="px-3 py-1 bg-blue-500 text-white text-xs rounded-md hover:bg-blue-600"
                                    >
                                      Do≈ÇƒÖcz siƒô do zakupu
                                    </button>
                                  ) : (
                                    /* For local purchases or joined foreign purchases, show quantity input */
                                    <div className="flex items-center">
                                      <input
                                        type="number"
                                        value={purchase.quantity}
                                        onChange={(e) =>
                                          handlePurchaseChange(
                                            purchase.id,
                                            "quantity",
                                            e.target.value
                                          )
                                        }
                                        className="w-20 p-1 border border-gray-300 rounded-md mr-2"
                                      />
                                      <button
                                        onClick={() =>
                                          toggleAiPanel(
                                            purchase.id === 1
                                              ? "generators"
                                              : purchase.item
                                                  .toLowerCase()
                                                  .includes("konserw")
                                              ? "cans"
                                              : "generic",
                                            purchase.id
                                          )
                                        }
                                        className="p-1 text-blue-600 hover:text-blue-800"
                                      >
                                        <BotIcon />
                                      </button>
                                    </div>
                                  )}
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </div>
                    {/* AI Assistant Panel REMOVED FROM HERE */}
                  </div>
                )}

                {activeTab === "resources" && (
                  <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                      <h3 className="text-lg font-semibold text-gray-800 mb-4">
                        Zapotrzebowanie na zasoby
                      </h3>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="p-4 border border-gray-200 rounded-lg">
                          <h4 className="font-medium text-gray-700 mb-2">
                            Zasoby konsumpcyjne - Mieszka≈Ñcy
                          </h4>
                          <div className="space-y-2 text-sm">
                            <div className="flex justify-between">
                              <span className="text-gray-600">
                                Kalorie dziennie:
                              </span>
                              <span className="font-medium">
                                {(
                                  demographicData.residents * 2200
                                ).toLocaleString()}{" "}
                                kcal
                              </span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-gray-600">Woda pitna:</span>
                              <span className="font-medium">
                                {(
                                  demographicData.residents * 3
                                ).toLocaleString()}{" "}
                                L/dzie≈Ñ
                              </span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-gray-600">
                                Woda techniczna:
                              </span>
                              <span className="font-medium">
                                {(
                                  demographicData.residents * 150
                                ).toLocaleString()}{" "}
                                L/dzie≈Ñ
                              </span>
                            </div>
                          </div>
                        </div>

                        <div className="p-4 border border-gray-200 rounded-lg">
                          <h4 className="font-medium text-gray-700 mb-2">
                            Zasoby konsumpcyjne - Tury≈õci
                          </h4>
                          <div className="space-y-2 text-sm">
                            <div className="flex justify-between">
                              <span className="text-gray-600">
                                Kalorie dziennie:
                              </span>
                              <span className="font-medium">
                                {(
                                  demographicData.tourists * 2200
                                ).toLocaleString()}{" "}
                                kcal
                              </span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-gray-600">Woda pitna:</span>
                              <span className="font-medium">
                                {(
                                  demographicData.tourists * 3
                                ).toLocaleString()}{" "}
                                L/dzie≈Ñ
                              </span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-gray-600">
                                Woda techniczna:
                              </span>
                              <span className="font-medium">
                                {(
                                  demographicData.tourists * 150
                                ).toLocaleString()}{" "}
                                L/dzie≈Ñ
                              </span>
                            </div>
                          </div>
                        </div>

                        <div className="p-4 border border-gray-200 rounded-lg">
                          <h4 className="font-medium text-gray-700 mb-2">
                            ≈ÅƒÖczne zapotrzebowanie (Ludzie{" "}
                            {animalManagementStrategy === "feed"
                              ? "+ Zwierzƒôta"
                              : ""}
                            )
                          </h4>
                          <div className="space-y-2 text-sm">
                            <div className="flex justify-between">
                              <span className="text-gray-600">
                                Kalorie dziennie:
                              </span>
                              <span className="font-medium">
                                {(
                                  (demographicData.residents +
                                    demographicData.tourists) *
                                  2200
                                ).toLocaleString()}{" "}
                                kcal
                              </span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-gray-600">
                                Woda pitna (Ludzie):
                              </span>
                              <span className="font-medium">
                                {(
                                  (demographicData.residents +
                                    demographicData.tourists) *
                                  3
                                ).toLocaleString()}{" "}
                                L/dzie≈Ñ
                              </span>
                            </div>
                            {animalManagementStrategy === "feed" && (
                              <>
                                <div className="flex justify-between pt-1 mt-1 border-t border-dashed">
                                  <span className="text-gray-500">
                                    Pasza dla zwierzƒÖt:
                                  </span>
                                  <span className="font-medium">
                                    {demographicData.animalPopulations
                                      .reduce(
                                        (sum, animal) =>
                                          sum +
                                          animal.count * animal.foodPerDayKg,
                                        0
                                      )
                                      .toLocaleString()}{" "}
                                    kg/dzie≈Ñ
                                  </span>
                                </div>
                                <div className="flex justify-between">
                                  <span className="text-gray-500">
                                    Woda dla zwierzƒÖt:
                                  </span>
                                  <span className="font-medium">
                                    {demographicData.animalPopulations
                                      .reduce(
                                        (sum, animal) =>
                                          sum +
                                          animal.count * animal.waterPerDayL,
                                        0
                                      )
                                      .toLocaleString()}{" "}
                                    L/dzie≈Ñ
                                  </span>
                                </div>
                              </>
                            )}
                            <div className="flex justify-between pt-1 mt-1 border-t">
                              <span className="text-gray-600 font-semibold">
                                Woda techniczna (≈ÅƒÖcznie):
                              </span>
                              <span className="font-bold text-gray-800">
                                {(
                                  (demographicData.residents +
                                    demographicData.tourists) *
                                    150 +
                                  (animalManagementStrategy === "feed"
                                    ? demographicData.animalPopulations.reduce(
                                        (sum, animal) =>
                                          sum +
                                          animal.count * animal.waterPerDayL,
                                        0
                                      )
                                    : 0)
                                ).toLocaleString()}{" "}
                                L/dzie≈Ñ
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* Animal Resources Section - MOVED HERE */}
                    <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mt-6">
                      <h3 className="text-lg font-semibold text-gray-800 mb-4">
                        Zasoby i zapotrzebowanie - Zwierzƒôta rolnicze
                      </h3>

                      <div className="mb-4">
                        <h4 className="font-medium text-gray-700 mb-2">
                          Strategia zarzƒÖdzania zwierzƒôtami:
                        </h4>
                        <div className="flex space-x-2">
                          <button
                            onClick={() => setAnimalManagementStrategy("feed")}
                            className={`px-3 py-1.5 text-sm rounded-md ${
                              animalManagementStrategy === "feed"
                                ? "bg-blue-600 text-white"
                                : "bg-gray-200 text-gray-700 hover:bg-gray-300"
                            }`}
                          >
                            Karmimy zwierzƒôta
                          </button>
                          <button
                            onClick={() =>
                              setAnimalManagementStrategy("food_source")
                            }
                            className={`px-3 py-1.5 text-sm rounded-md ${
                              animalManagementStrategy === "food_source"
                                ? "bg-orange-500 text-white"
                                : "bg-gray-200 text-gray-700 hover:bg-gray-300"
                            }`}
                          >
                            Zwierzƒôta jako ≈∫r√≥d≈Ço ≈ºywno≈õci
                          </button>
                          <button
                            onClick={() =>
                              setAnimalManagementStrategy("ignore")
                            }
                            className={`px-3 py-1.5 text-sm rounded-md ${
                              animalManagementStrategy === "ignore"
                                ? "bg-red-500 text-white"
                                : "bg-gray-200 text-gray-700 hover:bg-gray-300"
                            }`}
                          >
                            Ignorujemy (bez zaopatrzenia)
                          </button>
                        </div>
                      </div>

                      <h4 className="font-medium text-gray-700 mb-2">
                        Populacja zwierzƒÖt (dane szacunkowe z ARiMR/innych
                        ≈∫r√≥de≈Ç):
                      </h4>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        {demographicData.animalPopulations.map((animal) => (
                          <div
                            key={animal.id}
                            className="p-3 bg-gray-50 rounded-md"
                          >
                            <p className="font-semibold text-gray-700">
                              {animal.name}: {animal.count.toLocaleString()}
                            </p>
                          </div>
                        ))}
                      </div>

                      {animalManagementStrategy === "feed" && (
                        <div>
                          <h4 className="font-medium text-gray-700 mb-2">
                            Dzienne zapotrzebowanie zwierzƒÖt (przy strategii
                            'Karmimy'):
                          </h4>
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3 text-sm">
                            {demographicData.animalPopulations.map((animal) => {
                              const totalFoodKg =
                                animal.count * animal.foodPerDayKg;
                              const totalWaterL =
                                animal.count * animal.waterPerDayL;
                              return (
                                <div
                                  key={animal.id + "-demand"}
                                  className="border-b pb-2 mb-2"
                                >
                                  <p className="font-semibold text-gray-600">
                                    {animal.name}:
                                  </p>
                                  <div className="flex justify-between">
                                    <span className="text-gray-500">
                                      Pasza:
                                    </span>
                                    <span className="font-medium">
                                      {totalFoodKg.toLocaleString()} kg/dzie≈Ñ
                                    </span>
                                  </div>
                                  <div className="flex justify-between">
                                    <span className="text-gray-500">Woda:</span>
                                    <span className="font-medium">
                                      {totalWaterL.toLocaleString()} L/dzie≈Ñ
                                    </span>
                                  </div>
                                </div>
                              );
                            })}
                            {/* Total for animals */}
                            <div className="md:col-span-2 mt-2 pt-2 border-t">
                              <p className="font-semibold text-gray-700">
                                ≈ÅƒÖcznie dla zwierzƒÖt (przy strategii 'Karmimy'):
                              </p>
                              <div className="flex justify-between">
                                <span className="text-gray-600">Pasza:</span>
                                <span className="font-bold text-gray-800">
                                  {demographicData.animalPopulations
                                    .reduce(
                                      (sum, animal) =>
                                        sum +
                                        animal.count * animal.foodPerDayKg,
                                      0
                                    )
                                    .toLocaleString()}{" "}
                                  kg/dzie≈Ñ
                                </span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-gray-600">Woda:</span>
                                <span className="font-bold text-gray-800">
                                  {demographicData.animalPopulations
                                    .reduce(
                                      (sum, animal) =>
                                        sum +
                                        animal.count * animal.waterPerDayL,
                                      0
                                    )
                                    .toLocaleString()}{" "}
                                  L/dzie≈Ñ
                                </span>
                              </div>
                            </div>
                          </div>
                        </div>
                      )}

                      {animalManagementStrategy === "food_source" && (
                        <div className="p-3 bg-orange-50 border border-orange-200 rounded-md">
                          <h4 className="font-medium text-orange-700 mb-1">
                            Informacja: Zwierzƒôta jako ≈∫r√≥d≈Ço ≈ºywno≈õci
                          </h4>
                          <p className="text-sm text-orange-600">
                            Przy tej strategii, zasoby zwierzƒôce sƒÖ traktowane
                            jako potencjalne ≈∫r√≥d≈Ço po≈ºywienia dla ludno≈õci.
                            Nale≈ºy uwzglƒôdniƒá ich warto≈õƒá kalorycznƒÖ i wagƒô
                            miƒôsa w bilansie ≈ºywno≈õciowym. Nie jest kalkulowane
                            zapotrzebowanie na paszƒô i wodƒô dla zwierzƒÖt.
                          </p>
                        </div>
                      )}
                    </div>

                    {/* Strategic Grain Reserves Section - MOVED HERE */}
                    <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mt-6">
                      <h3 className="text-lg font-semibold text-gray-800 mb-4">
                        Zapasy strategiczne - Rolnictwo
                      </h3>
                      <div className="p-3 bg-indigo-50 border border-indigo-200 rounded-md">
                        <h4 className="font-medium text-indigo-700 mb-1">
                          Rezerwy zbo≈ºa na siewy
                        </h4>
                        <p className="text-2xl font-bold text-indigo-800">
                          {demographicData.grainReservesForSowingTonnes.toLocaleString()}{" "}
                          ton
                        </p>
                        <p className="text-sm text-indigo-600 mt-1">
                          Uwaga: W sytuacji krytycznej, te rezerwy mogƒÖ zostaƒá
                          rozwa≈ºone jako ≈∫r√≥d≈Ço po≈ºywienia dla ludno≈õci lub
                          paszy dla zwierzƒÖt (po odpowiednim przetworzeniu).
                        </p>
                      </div>
                    </div>
                  </div>
                )}

                {activeTab === "storage" && (
                  <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                      <div className="flex justify-between items-center mb-6">
                        <h3 className="text-lg font-semibold text-gray-800">
                          Magazynowanie zasob√≥w
                        </h3>
                        <button className="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                          <PlusCircleIcon />
                          <span className="ml-2">Dodaj zas√≥b</span>
                        </button>
                      </div>

                      <div className="mb-4 flex gap-4">
                        <input
                          type="text"
                          placeholder="Szukaj zasob√≥w..."
                          className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                        />
                        <select className="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                          <option value="">Wszystkie kategorie</option>
                          <option value="sprzƒôt">Sprzƒôt</option>
                          <option value="zasoby">Zasoby</option>
                          <option value="infrastruktura">Infrastruktura</option>
                          <option value="personel">Personel</option>
                        </select>
                        <select className="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                          <option value="">Wszystkie statusy</option>
                          <option value="sprawny">Sprawny</option>
                          <option value="dostƒôpny">Dostƒôpny</option>
                          <option value="w_u≈ºyciu">W u≈ºyciu</option>
                          <option value="w_naprawie">W naprawie</option>
                        </select>
                      </div>

                      <div className="overflow-x-auto">
                        <table className="w-full">
                          <thead>
                            <tr
                              style={{
                                backgroundColor: "#182139",
                                color: "white",
                              }}
                            >
                              <th className="px-4 py-3 text-left font-medium">
                                Nazwa zasobu
                              </th>
                              <th className="px-4 py-3 text-left font-medium">
                                Kategoria
                              </th>
                              <th className="px-4 py-3 text-left font-medium">
                                Status
                              </th>
                              <th className="px-4 py-3 text-left font-medium">
                                Lokalizacja
                              </th>
                              <th className="px-4 py-3 text-left font-medium">
                                Odpowiedzialny
                              </th>
                              <th className="px-4 py-3 text-left font-medium">
                                PrzeglƒÖd
                              </th>
                              <th className="px-4 py-3 text-left font-medium">
                                Akcje
                              </th>
                            </tr>
                          </thead>
                          <tbody className="divide-y divide-gray-200">
                            {resources.map((resource, index) => (
                              <tr
                                key={resource.id}
                                className={
                                  index % 2 === 0 ? "bg-white" : "bg-gray-50"
                                }
                              >
                                <td className="px-4 py-3 text-sm text-gray-800">
                                  {resource.name}
                                </td>
                                <td className="px-4 py-3 text-sm text-gray-600">
                                  {resource.category}
                                </td>
                                <td className="px-4 py-3">
                                  <span
                                    className={`inline-flex px-2 py-1 text-xs font-medium rounded-full ${getStatusColor(
                                      resource.status
                                    )}`}
                                  >
                                    {statusLabels[resource.status]}
                                  </span>
                                </td>
                                <td className="px-4 py-3 text-sm text-gray-600">
                                  {resource.location}
                                </td>
                                <td className="px-4 py-3 text-sm text-gray-600">
                                  {resource.responsible}
                                </td>
                                <td className="px-4 py-3 text-sm text-gray-600">
                                  {resource.nextInspection}
                                </td>
                                <td className="px-4 py-3">
                                  <div className="flex space-x-2">
                                    <button className="p-1 text-gray-400 hover:text-blue-600">
                                      <EyeIcon />
                                    </button>
                                    <button className="p-1 text-gray-400 hover:text-green-600">
                                      <Edit2Icon />
                                    </button>
                                  </div>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                      <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <h4 className="font-medium text-gray-700 mb-4">
                          Jednostki sta≈Çe
                        </h4>
                        <div className="space-y-2">
                          <div className="flex justify-between text-sm">
                            <span className="text-gray-600">Publiczne:</span>
                            <span className="font-medium">8</span>
                          </div>
                          <div className="flex justify-between text-sm">
                            <span className="text-gray-600">
                              Prywatne (z umowƒÖ):
                            </span>
                            <span className="font-medium">3</span>
                          </div>
                          <div className="flex justify-between text-sm border-t pt-2">
                            <span className="text-gray-600">≈ÅƒÖcznie:</span>
                            <span className="font-medium">11</span>
                          </div>
                        </div>
                      </div>

                      <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <h4 className="font-medium text-gray-700 mb-4">
                          Jednostki mobilne
                        </h4>
                        <div className="space-y-2">
                          <div className="flex justify-between text-sm">
                            <span className="text-gray-600">Beczkowozy:</span>
                            <span className="font-medium">2</span>
                          </div>
                          <div className="flex justify-between text-sm">
                            <span className="text-gray-600">
                              Kontenery mobilne:
                            </span>
                            <span className="font-medium">4</span>
                          </div>
                          <div className="flex justify-between text-sm border-t pt-2">
                            <span className="text-gray-600">≈ÅƒÖcznie:</span>
                            <span className="font-medium">6</span>
                          </div>
                        </div>
                      </div>

                      <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <h4 className="font-medium text-gray-700 mb-4">
                          Warunki przechowywania
                        </h4>
                        <div className="space-y-2">
                          <div className="flex justify-between text-sm">
                            <span className="text-gray-600">Ch≈Çodnicze:</span>
                            <span className="font-medium">3 jednostki</span>
                          </div>
                          <div className="flex justify-between text-sm">
                            <span className="text-gray-600">Suche:</span>
                            <span className="font-medium">5 jednostek</span>
                          </div>
                          <div className="flex justify-between text-sm">
                            <span className="text-gray-600">Specjalne:</span>
                            <span className="font-medium">2 jednostki</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {activeTab === "inventory" && (
                  <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                      <div className="flex justify-between items-center mb-6">
                        <h3 className="text-lg font-semibold text-gray-800">
                          Remanent zasob√≥w
                        </h3>
                        <button className="flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                          <RefreshCwIcon />
                          <span className="ml-2">Rozpocznij remanent</span>
                        </button>
                      </div>

                      <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div className="p-4 border border-gray-200 rounded-lg">
                          <div className="flex items-center justify-between">
                            <span className="text-sm text-gray-600">
                              Zasoby sprawne
                            </span>
                            <CheckCircleIcon />
                          </div>
                          <div className="mt-2">
                            <span className="text-2xl font-bold text-gray-800">
                              127
                            </span>
                            <span className="text-sm text-gray-600 ml-1">
                              / 156
                            </span>
                          </div>
                        </div>

                        <div className="p-4 border border-gray-200 rounded-lg">
                          <div className="flex items-center justify-between">
                            <span className="text-sm text-gray-600">
                              W u≈ºyciu
                            </span>
                            <EyeIcon />
                          </div>
                          <div className="mt-2">
                            <span className="text-2xl font-bold text-gray-800">
                              42
                            </span>
                            <span className="text-sm text-gray-600 ml-1">
                              / 156
                            </span>
                          </div>
                        </div>

                        <div className="p-4 border border-gray-200 rounded-lg">
                          <div className="flex items-center justify-between">
                            <span className="text-sm text-gray-600">
                              W naprawie
                            </span>
                            <AlertCircleIcon />
                          </div>
                          <div className="mt-2">
                            <span className="text-2xl font-bold text-gray-800">
                              8
                            </span>
                            <span className="text-sm text-gray-600 ml-1">
                              / 156
                            </span>
                          </div>
                        </div>

                        <div className="p-4 border border-gray-200 rounded-lg">
                          <div className="flex items-center justify-between">
                            <span className="text-sm text-gray-600">
                              WymagajƒÖ przeglƒÖdu
                            </span>
                            <CalendarIcon />
                          </div>
                          <div className="mt-2">
                            <span className="text-2xl font-bold text-gray-800">
                              12
                            </span>
                            <span className="text-sm text-gray-600 ml-1">
                              / 156
                            </span>
                          </div>
                        </div>
                      </div>

                      <div className="border-t pt-6">
                        <h4 className="font-medium text-gray-700 mb-4">
                          Historia remanentu
                        </h4>
                        <div className="space-y-2">
                          <div className="flex justify-between items-center py-2 border-b border-gray-100">
                            <div>
                              <span className="text-sm font-medium">
                                Remanent roczny 2025
                              </span>
                              <span className="block text-xs text-gray-600">
                                15 kwietnia 2025, 08:30
                              </span>
                            </div>
                            <span className="text-sm text-green-600">
                              Zako≈Ñczony
                            </span>
                          </div>
                          <div className="flex justify-between items-center py-2 border-b border-gray-100">
                            <div>
                              <span className="text-sm font-medium">
                                Remanent kwartalny Q1
                              </span>
                              <span className="block text-xs text-gray-600">
                                28 marca 2025, 14:15
                              </span>
                            </div>
                            <span className="text-sm text-green-600">
                              Zako≈Ñczony
                            </span>
                          </div>
                          <div className="flex justify-between items-center py-2">
                            <div>
                              <span className="text-sm font-medium">
                                Remanent nadzwyczajny
                              </span>
                              <span className="block text-xs text-gray-600">
                                10 lutego 2025, 10:00
                              </span>
                            </div>
                            <span className="text-sm text-yellow-600">
                              W trakcie
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {activeTab === "reports" && (
                  <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                      <div className="flex justify-between items-center mb-6">
                        <h3 className="text-lg font-semibold text-gray-800">
                          Raporty i analizy
                        </h3>
                        <button className="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                          <FileTextIcon />
                          <span className="ml-2">Generuj raport</span>
                        </button>
                      </div>

                      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div className="border border-gray-200 rounded-lg p-4">
                          <div className="flex items-center justify-between mb-2">
                            <h4 className="font-medium text-gray-700">
                              Raport cykliczny
                            </h4>
                            <CalendarIcon />
                          </div>
                          <p className="text-sm text-gray-600 mb-4">
                            Automatyczny raport miesiƒôczny stanu zasob√≥w
                          </p>
                          <button className="text-sm text-blue-600 hover:text-blue-700">
                            Skonfiguruj
                          </button>
                        </div>

                        <div className="border border-gray-200 rounded-lg p-4">
                          <div className="flex items-center justify-between mb-2">
                            <h4 className="font-medium text-gray-700">
                              Raport CAP-Resource
                            </h4>
                            <UploadIcon />
                          </div>
                          <p className="text-sm text-gray-600 mb-4">
                            Eksport w formacie CAP-Resource dla integracji
                          </p>
                          <button className="text-sm text-green-600 hover:text-green-700">
                            Generuj
                          </button>
                        </div>

                        <div className="border border-gray-200 rounded-lg p-4">
                          <div className="flex items-center justify-between mb-2">
                            <h4 className="font-medium text-gray-700">
                              Analiza trend√≥w
                            </h4>
                            <BarChart3Icon />
                          </div>
                          <p className="text-sm text-gray-600 mb-4">
                            Trendy wykorzystania i stanu zasob√≥w
                          </p>
                          <button className="text-sm text-purple-600 hover:text-purple-700">
                            Zobacz
                          </button>
                        </div>
                      </div>

                      <div className="border-t pt-6">
                        <h4 className="font-medium text-gray-700 mb-4">
                          Ostatnie raporty
                        </h4>
                        <div className="space-y-2">
                          <div className="flex justify-between items-center py-2 border-b border-gray-100">
                            <div className="flex items-center">
                              <FileTextIcon />
                              <div className="ml-3">
                                <span className="text-sm font-medium">
                                  Raport miesiƒôczny - Kwiecie≈Ñ 2025
                                </span>
                                <span className="block text-xs text-gray-600">
                                  5 maja 2025, 09:15
                                </span>
                              </div>
                            </div>
                            <button className="text-sm text-blue-600 hover:text-blue-700">
                              Pobierz
                            </button>
                          </div>
                          <div className="flex justify-between items-center py-2 border-b border-gray-100">
                            <div className="flex items-center">
                              <FileTextIcon />
                              <div className="ml-3">
                                <span className="text-sm font-medium">
                                  Raport remanentu Q1 2025
                                </span>
                                <span className="block text-xs text-gray-600">
                                  2 kwietnia 2025, 14:30
                                </span>
                              </div>
                            </div>
                            <button className="text-sm text-blue-600 hover:text-blue-700">
                              Pobierz
                            </button>
                          </div>
                          <div className="flex justify-between items-center py-2">
                            <div className="flex items-center">
                              <FileTextIcon />
                              <div className="ml-3">
                                <span className="text-sm font-medium">
                                  Analiza zapotrzebowania - Marzec 2025
                                </span>
                                <span className="block text-xs text-gray-600">
                                  28 marca 2025, 11:00
                                </span>
                              </div>
                            </div>
                            <button className="text-sm text-blue-600 hover:text-blue-700">
                              Pobierz
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </main>
            </div>
            {/* AI Assistant Panel */}
            {showAiPanel && (
              <div
                id="ai-panel"
                className="bg-gray-800 text-white shadow-lg overflow-hidden transition-all duration-300 ease-in-out ai-panel-fixed"
                style={{
                  width: `${aiPanelWidth}px`,
                }}
              >
                <div
                  className="absolute top-0 bottom-0 left-0 w-2 cursor-col-resize bg-gray-600 hover:bg-blue-500 transition-colors z-10"
                  onMouseDown={startResize}
                ></div>
                {/* Actual AI content needs padding due to resizer taking up left edge */}
                <div className="pl-2 flex flex-col h-full">
                  {" "}
                  {/* Added pl-2 to not overlap resizer, and h-full */}
                  <div className="p-4 border-b border-gray-700 flex justify-between items-center">
                    <h3 className="text-lg font-semibold flex items-center">
                      <img
                        src="SharkIT-assistant.png"
                        alt="SharkIT Assistant"
                        className="h-6 w-6 mr-2"
                        style={{ cursor: "default" }}
                      />
                      Asystent AI
                    </h3>
                    <div className="flex items-center space-x-2">
                      {/* Add recycle bin button */}
                      <button
                        onClick={() => {
                          if (
                            confirm(
                              "Czy na pewno chcesz wyczy≈õciƒá historiƒô konwersacji?"
                            )
                          ) {
                            // Clear localStorage for current context
                            const contextKey = `aiConversationLog_${
                              currentAiContext?.type || "default"
                            }`;
                            localStorage.removeItem(contextKey);
                            // Reset conversation in state
                            setAiAssistantLog([
                              {
                                sender: "ai",
                                message:
                                  "Witaj! Jestem asystentem AI dla systemu monitorowania zasob√≥w. W czym mogƒô pom√≥c?",
                                timestamp: new Date().toLocaleTimeString([], {
                                  hour: "2-digit",
                                  minute: "2-digit",
                                }),
                              },
                            ]);
                          }
                        }}
                        className="text-gray-400 hover:text-red-500 transition-colors"
                        title="Wyczy≈õƒá historiƒô konwersacji"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          className="h-5 w-5"
                          viewBox="0 0 20 20"
                          fill="currentColor"
                        >
                          <path
                            fillRule="evenodd"
                            d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
                            clipRule="evenodd"
                          />
                        </svg>
                      </button>
                      <button
                        onClick={() => setShowAiPanel(false)}
                        className="text-gray-400 hover:text-white transition-colors"
                      >
                        ‚úï
                      </button>
                    </div>
                  </div>
                  <div className="flex-1 p-4 overflow-y-auto space-y-3 text-sm">
                    <div className="space-y-1">
                      <p className="font-semibold">
                        Kontekst:{" "}
                        {currentAiContext?.type === "generators"
                          ? "Zakup agregat√≥w"
                          : currentAiContext?.type === "cans"
                          ? "Zakup konserw"
                          : currentAiContext?.type === "emergency"
                          ? "Sytuacja kryzysowa"
                          : currentAiContext?.type === "resources"
                          ? "Zasoby gminy"
                          : currentAiContext?.type === "freestyle"
                          ? "Swobodna rozmowa"
                          : "Og√≥lny"}
                      </p>
                      <p className="text-xs text-gray-400">
                        Model:{" "}
                        {currentAiContext?.type === "freestyle" ||
                        currentAiContext?.mockCompleted
                          ? "GPT-4.1 Nano"
                          : "Asystent Demo"}
                      </p>
                    </div>

                    {/* AI Analysis Plan */}
                    {aiAnalysisPlan.length > 0 && (
                      <div className="mb-3">
                        <p className="font-medium text-gray-300">
                          Plan Analizy:
                        </p>
                        <ul className="list-disc list-inside pl-2 text-gray-400 text-xs">
                          {aiAnalysisPlan.map((step, i) => (
                            <li key={i}>{step}</li>
                          ))}
                        </ul>
                      </div>
                    )}

                    {/* AI Log / Chat */}
                    <div className="space-y-2">
                      {aiAssistantLog.map((log, i) => (
                        <div
                          key={i}
                          className={`p-2 rounded-md ${
                            log.sender === "ai"
                              ? "bg-gray-700"
                              : "bg-blue-600 self-end"
                          }`}
                        >
                          <p className="font-bold text-xs mb-0.5">
                            {log.sender === "ai" ? "Asystent" : "U≈ºytkownik"}
                          </p>
                          <p className="text-xs whitespace-pre-wrap">
                            {log.message}
                          </p>
                          {log.actions &&
                            log.actions.map((action, idx) => (
                              <button
                                key={idx}
                                onClick={() =>
                                  handleAiAction(action.type, action.value)
                                }
                                className="mt-1.5 mr-1.5 px-2 py-0.5 bg-blue-500 text-white text-xs rounded hover:bg-blue-400"
                              >
                                {action.label}
                              </button>
                            ))}
                        </div>
                      ))}
                    </div>

                    {/* AI Suggestions (Buttons) */}
                    {aiSuggestions.length > 0 && (
                      <div className="pt-3 border-t border-gray-700">
                        <p className="font-medium text-gray-300">Sugestie:</p>
                        <div className="flex flex-wrap gap-2 mt-1">
                          {aiSuggestions.map((sug, i) => (
                            <button
                              key={i}
                              onClick={() => applyAiSuggestion(sug.value)}
                              className="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-500"
                            >
                              {sug.label}
                            </button>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                  <div className="p-3 border-t border-gray-700">
                    <div className="flex mb-3">
                      <input
                        type="text"
                        onKeyDown={handleAiChatInput}
                        placeholder="Wpisz wiadomo≈õƒá do asystenta..."
                        className="flex-1 px-3 py-2 bg-gray-700 text-white rounded-l text-sm border border-gray-600 focus:outline-none focus:border-blue-500"
                      />
                      <button
                        onClick={(e) => {
                          const input = e.target.previousSibling;
                          if (input.value.trim()) {
                            handleAiAction("send_message", input.value.trim());
                            input.value = "";
                          }
                        }}
                        className="px-4 py-2 bg-blue-600 text-white rounded-r text-sm hover:bg-blue-500"
                      >
                        Wy≈õlij
                      </button>
                    </div>
                    {/* Bottom buttons (Zamknij, Minimalizuj) - REMOVED */}
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      };

      // Main App Component
      const App = () => {
        const [currentView, setCurrentView] = React.useState("home");

        // Home Screen Component
        const HomeScreen = () => {
          const roles = [
            {
              id: "local-admin",
              title: "ZarzƒÖdca Lokalny",
              description:
                "Panel dla w√≥jta, burmistrza i koordynatora lokalnego",
              icon: UserIcon,
              color: "blue",
              bgColor: "bg-blue-50",
              borderColor: "border-blue-200",
              textColor: "text-blue-700",
              action: () => setCurrentView("local-admin"),
            },
            {
              id: "global-admin",
              title: "ZarzƒÖdca Globalny",
              description: "Panel dla wojewody i koordynatora regionu",
              icon: UsersIcon,
              color: "green",
              bgColor: "bg-green-50",
              borderColor: "border-green-200",
              textColor: "text-green-700",
              action: () => setCurrentView("global-admin"),
            },
            {
              id: "local-crisis",
              title: "Tryb Kryzysowy - Lokalny",
              description: "Panel dla stra≈ºaka, dyspozytora OSP",
              icon: AlertCircleIcon,
              color: "orange",
              bgColor: "bg-orange-50",
              borderColor: "border-orange-200",
              textColor: "text-orange-700",
              action: () => setCurrentView("local-crisis"),
            },
            {
              id: "global-crisis",
              title: "Tryb Kryzysowy - Globalny",
              description: "Panel dla wojewody i centrali kryzysowej",
              icon: ShieldIcon,
              color: "red",
              bgColor: "bg-red-50",
              borderColor: "border-red-200",
              textColor: "text-red-700",
              action: () => setCurrentView("global-crisis"),
            },
          ];

          return (
            <div className="min-h-screen bg-gray-50">
              {/* Header */}
              <header
                style={{ backgroundColor: "#182139", color: "white" }}
                className="shadow-sm"
              >
                <div className="max-w-7xl mx-auto px-4 py-6">
                  <h1 className="text-2xl font-bold">
                    Centrum Monitorowania Zasob√≥w
                  </h1>
                  <p className="mt-1 text-gray-300">
                    System zarzƒÖdzania kryzysowego i obrony cywilnej
                  </p>
                </div>
              </header>

              {/* Main Content */}
              <main className="max-w-7xl mx-auto px-4 py-8">
                <div className="mb-8 text-center">
                  <h2 className="text-xl font-semibold text-gray-800 mb-2">
                    Wybierz swojƒÖ rolƒô
                  </h2>
                  <p className="text-gray-600">
                    Kliknij na odpowiedniƒÖ rolƒô, aby uzyskaƒá dostƒôp do
                    dedykowanego panelu
                  </p>
                </div>

                {/* Role Cards Grid */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                  {roles.map((role) => {
                    const Icon = role.icon;
                    return (
                      <button
                        key={role.id}
                        onClick={role.action}
                        className={`role-card p-6 rounded-lg border ${role.bgColor} ${role.borderColor} transition-all duration-200 hover:shadow-lg`}
                      >
                        <div className="flex flex-col items-center text-center">
                          <div
                            className={`p-4 rounded-full ${role.bgColor} border ${role.borderColor} ${role.textColor}`}
                          >
                            <Icon />
                          </div>
                          <h3 className="mt-4 font-medium text-gray-800">
                            {role.title}
                          </h3>
                          <p className="mt-2 text-sm text-gray-600">
                            {role.description}
                          </p>
                          <div
                            className={`mt-4 inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${role.bgColor} ${role.textColor}`}
                          >
                            Otw√≥rz panel
                          </div>
                        </div>
                      </button>
                    );
                  })}
                </div>

                {/* Info Section */}
                <div className="mt-12 bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                  <h3 className="font-medium text-gray-700 mb-2">O systemie</h3>
                  <p className="text-sm text-gray-600">
                    System Centrum Monitorowania Zasob√≥w zosta≈Ç opracowany, aby
                    zapewniƒá s≈Çu≈ºbom zarzƒÖdzania kryzysowego i obrony cywilnej
                    bie≈ºƒÖcy, wiarygodny obraz zasob√≥w dostƒôpnych na danym
                    terenie. Pozwala na skr√≥cenie czasu alokacji zasob√≥w w
                    sytuacji zagro≈ºenia, ograniczenie dublowania zakup√≥w i chaos
                    logistyczny, oraz u≈Çatwienie wsp√≥lnego planowania miƒôdzy
                    gminami, powiatami i NGO.
                  </p>
                </div>
              </main>

              {/* Footer */}
              <footer className="mt-12 bg-white border-t">
                <div className="max-w-7xl mx-auto px-4 py-4">
                  <p className="text-sm text-gray-600 text-center">
                    System zgodny z wymaganiami przepis√≥w o ochronie ludno≈õci i
                    obronie cywilnej
                  </p>
                </div>
              </footer>
            </div>
          );
        };

        // Expose setCurrentView for child components
        window.setCurrentView = setCurrentView;

        // Render appropriate view based on current state
        switch (currentView) {
          case "local-admin":
            return <LocalAdminDashboard />;
          case "global-admin":
            return <GlobalAdmin />;
          case "local-crisis":
            return <LocalCrisisMode />;
          case "global-crisis":
            return <GlobalCrisisMode />;
          default:
            return <HomeScreen />;
        }
      };

      // Render the app
      const container = document.getElementById("root");
      const root = ReactDOM.createRoot(container);
      root.render(<App />);
    </script>
  </body>
</html>
